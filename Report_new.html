<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DATA3888 Report: Optiver 13</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="Report_new_files/libs/clipboard/clipboard.min.js"></script>
<script src="Report_new_files/libs/quarto-html/quarto.js"></script>
<script src="Report_new_files/libs/quarto-html/popper.min.js"></script>
<script src="Report_new_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Report_new_files/libs/quarto-html/anchor.min.js"></script>
<link href="Report_new_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Report_new_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Report_new_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Report_new_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Report_new_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DATA3888 Report: Optiver 13</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="executive-summary" class="level2">
<h2 class="anchored" data-anchor-id="executive-summary">Executive Summary</h2>
<p>The purpose of this project is to develop a model that accurately predicts volatility and to explain the model clearly to traders at Optiver. Our project has two key results. First, we found that SVM(Support Vector Machine) is most accurate for predicting the future volatility of most stocks, although ridge regression also performs well. Second, we deployed an interactive Shiny App to effectively communicate our results to traders.</p>
<p>This project is practically relevant because volatility is an essential component of the Black-Scholes equation, which is important for options pricing. Therefore, our results on optimizing model accuracy and improving model communication can help traders to make effective trading strategies.</p>
</section>
<section id="aim-and-background" class="level2">
<h2 class="anchored" data-anchor-id="aim-and-background">Aim and Background</h2>
<p><strong>Aim</strong></p>
<p>Volatility is the degree of variation observed in the price of a financial instrument over time and is a key measure of market risk. For any trading firm including Optiver, volatility is crucial in option pricing and trading strategies.</p>
<p>The aim of this project is to find the model that offers the best tradeoff among prediction accuracy, model interpretability and model robustness, and to investigate the effects that input stocks have on model performance.</p>
<p><strong>Multidisciplinarity</strong></p>
<p>This project requires both finance and data science knowledge. From the financial perspective, understanding and predicting volatility is critical for successful trading strategies. From the data science standpoint, predicting volatility is a complicated task involving time series prediction, which is generally characterized by non-linear, non-stationary, and potentially high-dimensional data. The development of a reliable volatility prediction model would therefore require a deep understanding of both of these domains.</p>
<p><strong>Motivational background</strong></p>
<p>For any complex models, there is necessarily a tradeoff between predictive power and interpretability. Indeed, Optiver identifies such an issue, so they value a model’s interpretability as much as its performance. Consequently, Optiver approached DATA3888 students to grapple with this tradeoff by developing a model to accurately predict volatility, and also effectively communicating that model to traders.&nbsp;<br>
</p>
<p>Despite being a critical measure for trading, volatility is inherently difficult to predict. Traditional models like the GARCH model and its variants have limitations due to their assumptions and rigid structure. In this project, our group evaluated various models, from basic models like regression to deep learning models like LSTM, to find the best model for predicting volatility. At the same time, we are aware of the interpretability problem and aims to explain our model clearly.</p>
</section>
<section id="method" class="level2">
<h2 class="anchored" data-anchor-id="method">Method</h2>
<section id="a.-data-science-perspective" class="level3">
<h3 class="anchored" data-anchor-id="a.-data-science-perspective">A. Data Science Perspective</h3>
<p>The data for this project is the relevant stock datasets provided by Optiver. Our stock data consists of price, volume and time variables, including bid price, ask price, bid size, ask size, time id and seconds in each time id.&nbsp;</p>
<p>After all models are trained, they were evaluated for their performance. This is done using a combination of graphical and quantitative method:</p>
<ol type="1">
<li><p>Graphical: The plots used for evaluation include actual v.s. predicted linear plots, box plots of RMSE for each cluster, QLIKE box plots for each cluster, and ACF plots. These graphics provide a visual indication of how well the model is performing.</p></li>
<li><p>Quantitative: Quantitative metrics provide a more direct assessment of the model’s performance. For the task of predicting volatility, these might include metrics like Root Mean Squared Error (RMSE), and R-squared.&nbsp;</p></li>
</ol>
<p>We developed six models in this project: ARMA-GARCH, HAV-RV, SVM, Ridge Regression, Random Forest and LSTM.</p>
<p><strong>ARMA-GARCH</strong></p>
<p>ARMA-GARCH models are a combination of Autoregressive Moving Average (ARMA) and Generalised Autoregressive Conditional Heteroskedasticity (GARCH) models. ARMA models consist of an autoregressive element, which predicts future values based on past values, and a moving average element, which takes into account the errors from previous predictions. GARCH models predict the volatility of a time series.&nbsp;</p>
<p>This model was chosen for this project because it is conventionally used by the finance industry to predict volatility. GARCH models with non-normal distributions are robust for predicting volatility (Liu and Morley).</p>
<p>The main assumption for the model is stationarity (see appendix).&nbsp;</p>
<p><strong>HAV-RV</strong></p>
<p>The HAR-RV model (Heterogeneous Autoregressive Realized Volatility model) works directly on realized volatility to predict future volatility. Because this model is generally used for daily realized volatility while our data’s time interval is much shorter, HAR-RV model in this project only serves as a benchmark. We used realized volatility for the previous time interval and the mean realized volatility for the past five time intervals to predict future volatility. Since stock datasets are highly complex, we used Weighted Least Square for prediction.</p>
<p><strong>SVM</strong></p>
<p>SVM model performs well with highly complex data. Since stock datasets are complicated, our group believe that SVM is an important model to be evaluated. Choosing a suitable kernel is crucial for SVM’s performance, and we chose Radial Basis Function (RBF) because this works well for non-linear and complex relationships, such as predicting volatility in our case. However, downsides of RBF includes overfitting and high training time, which are important aspects for evaluation.&nbsp;</p>
<p><strong>Ridge Regression</strong></p>
<p>Ridge regression is a regularized linear regression method, which is part of the elastic network of the generalized linear regression model and controls model complexity by introducing an L2 regularization term. Unlike ordinary linear regression, ridge regression adds a regularization term to the objective function, which is the product of the sum of the squares of the coefficients and a regularization parameter lambda. Ridge regressions requires tuning parameters. The parameter lambda determines the strength of model regularization, and a larger lambda means a stronger regularization. When performing model tuning, different lambda values are usually tried, and the best lambda value is selected through methods such as cross-validation. This is to find a balance between bias and variance to obtain a model with better generalization ability.</p>
<p><strong>LSTM</strong></p>
<p>The LSTM (Long Short-Term Memory) deep learning model is a type of recurrent neural network designed to capture long-term dependencies in sequential data. LSTMs have memory cells controlled by input, forget and output gates. This model is chosen when long-term dependencies are important. For our implementation, we defined the layers and the corresponding parameters, chose the fitness loss function to the model, trained the model using training datasets and finally used the validation data to adjust the prediction value. After all the epochs (like the iterative times), the model is trained and ready to be used.</p>
<p><strong>Random Forest</strong></p>
<p>A random forest model works by creating many decision trees, each of which is trained on a different subset of the data. The randomness comes from both choosing the subsets of data and choosing the subsets of features used for splitting each node in the tree. When making a prediction, random forest feeds the input data to each of the decision trees in the forest. Each tree gives a prediction independently from the others and decide a final results based on these independent predictions.&nbsp;</p>
<p>Advantages of random forest include robustness and flexibility. Random forest is less likely to overfit because the model averages the results of many different trees. Random Forest can handle both linear and non-linear relationships between predictors and the target variable, which is useful because the relationship between various factors and market volatility is non-linear and highly complex.</p>
</section>
<section id="b.-relevance-to-industry-partner" class="level3">
<h3 class="anchored" data-anchor-id="b.-relevance-to-industry-partner">B. <strong>Relevance to Industry Partner</strong></h3>
<p>Predicting volatility is relevant to Optiver because volatility is an important element in the Black-Scholes equation, which is used for options pricing, as well as for understanding risk.&nbsp;</p>
<p>ARMA-GARCH, HAR-RV and regression are conventionally used in the trading industry to predict volatility (cite). It was therefore relevant to Optiver to build and evaluate these models to either affirm or challenge their use by the firm, and to communicate these common models to traders. SVM, Random Forest, and LSTM are less commonly used; therefore, evaluating them and communicating them to traders was relevant to Optiver because there was scope to innovate upon the conventional models used in finance.&nbsp;</p>
<p>Comparing a variety of models was relevant to Optiver because not only did it mean developing and explaining models to traders, but justifying them on the basis of their accuracy and time cost. The value of this method is that it enables traders to feel more confident in accepting the model as the optimal to use. Time was a particularly important evaluative element because traders must make decisions quickly in real-time; models with long runtimes, regardless of their accuracy, would be impractical for most trading environments.&nbsp;</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<section id="a.-models" class="level3">
<h3 class="anchored" data-anchor-id="a.-models">A. Models</h3>
<p>In the project, our group evaluated the performance of six distinct models across the six clusters of the stock data. We considered three potential evaluation metrics, which are Root Mean Square Error (RMSE), the coefficient of determination (R^2), and Mean Absolute Error (MAE). Among these metrics, our group decided to use RMSE for evaluating model performance because RMSE gauges the mean square magnitude of errors, making it more sensitive to detect outliers. This characteristic is particularly valuable in analyzing financial data, which often harbors significant outliers and where the impact of errors can be considerable. Contrastingly, the Mean Absolute Error (MAE) measures the absolute magnitude of errors, which is less sensitive to outliers compared to RMSE. Such disadvantage also applies to R^2.</p>
<p>Our group tested the overall time required for each model to complete its prediction, and shorter time required is definitely an advantage in the rapidly evolving stock market.</p>
<p>In the table below, we show the mean RMSE values for each cluster and each model. More information can be found in boxplots in the appendix. In this table, SVM and Ridge Regression perform better, but RMSE of SVM possesse fewer outliers compared to Regression.</p>
<table class="table">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<tbody>
<tr class="odd">
<td></td>
<td>Cluster1</td>
<td>Cluster2</td>
<td>Cluster3</td>
<td>Cluster4</td>
<td>Cluster5</td>
<td>Cluster6</td>
</tr>
<tr class="even">
<td>ARMA-GARCH</td>
<td>0.000397717</td>
<td>0.000397711</td>
<td>0.000397592</td>
<td>0.000397779</td>
<td>0.000397691</td>
<td>0.00049788</td>
</tr>
<tr class="odd">
<td>SVM</td>
<td>0.000234895</td>
<td>0.000138351</td>
<td>0.000160307</td>
<td>0.000325224</td>
<td>0.000228932</td>
<td>0.00017798</td>
</tr>
<tr class="even">
<td>Ridge Regression</td>
<td>0.000257502</td>
<td>0.000186632</td>
<td>1.80E-04</td>
<td>0.000314913</td>
<td>0.000248003</td>
<td>0.00026557</td>
</tr>
<tr class="odd">
<td>LSTM</td>
<td>0.000307353</td>
<td>0.000529648</td>
<td>0.000259467</td>
<td>0.000631368</td>
<td>0.001059554</td>
<td>0.001005189</td>
</tr>
<tr class="even">
<td>Random Forest</td>
<td>0.000651958</td>
<td>4.27E-04</td>
<td>4.30E-04</td>
<td>7.86E-04</td>
<td>5.87E-04</td>
<td>6.07E-04</td>
</tr>
<tr class="odd">
<td>HAV-RV</td>
<td>0.000788709</td>
<td>0.000546498</td>
<td>0.000570423</td>
<td>0.001038327</td>
<td>0.000775287</td>
<td>0.000700853</td>
</tr>
</tbody>
</table>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read excel file that contains RMSEs for each model in a cluster</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>final <span class="ot">&lt;-</span>  <span class="fu">read_excel</span>(<span class="st">"./dataset/result/C2.xlsx"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Transfer some MSE to RMSE</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>final<span class="sc">$</span>LINEAR<span class="ot">&lt;-</span> <span class="fu">sqrt</span>(final<span class="sc">$</span>LINEAR)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>final<span class="sc">$</span>RF <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(final<span class="sc">$</span>RF)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Process the data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>final1 <span class="ot">&lt;-</span> <span class="fu">gather</span>(final)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>final1 <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(final1)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to do it in cluster 6 since there is a super high RMSE in it.</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> <span class="fu">which</span>(final1<span class="sc">$</span>value <span class="sc">==</span> <span class="fu">max</span>(final1<span class="sc">$</span>value))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>final1 <span class="ot">=</span> final1[<span class="sc">-</span>d,]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw the boxplot</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#0072B2"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final1, <span class="fu">aes</span>(<span class="at">x =</span> key, <span class="at">y =</span> value, <span class="at">fill =</span> key)) <span class="sc">+</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">notch =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.color =</span> <span class="st">"black"</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.shape =</span> <span class="dv">16</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="fl">0.5</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Models"</span>, <span class="at">y =</span> <span class="st">"Rmse"</span>) <span class="sc">+</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Boxplot for cluster6"</span>) <span class="sc">+</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#F5F5F5"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Report_new_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We also tested the computation time of each model using the same stock csv file and showed our result in the below boxplot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>rt <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'./dataset/result/All_Running_time.csv'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>SVM <span class="ot">&lt;-</span> rt[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>LM <span class="ot">&lt;-</span> rt[<span class="dv">2</span>,<span class="dv">1</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>MAR <span class="ot">&lt;-</span> rt[<span class="dv">3</span>,<span class="dv">1</span>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>LSTM <span class="ot">&lt;-</span> rt[<span class="dv">4</span>,<span class="dv">1</span>]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>HAV <span class="ot">&lt;-</span> rt[<span class="dv">5</span>,<span class="dv">1</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>RF <span class="ot">&lt;-</span> rt[<span class="dv">6</span>,<span class="dv">1</span>]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>runningtime <span class="ot">&lt;-</span> <span class="fu">c</span>(SVM, LM, MAR, LSTM, HAV, RF)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#000080"</span>, <span class="st">"#008000"</span>, <span class="st">"#FFA500"</span>, <span class="st">"#800000"</span>, <span class="st">"#FFC0CB"</span>, <span class="st">"#BBC0CB"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(runningtime, </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">names.arg =</span> <span class="fu">c</span>(<span class="st">"SVM"</span>, <span class="st">"Ridge"</span>, <span class="st">"Armagarch"</span>, <span class="st">"LSTM"</span>, <span class="st">"HAV-RV"</span>, <span class="st">"RF"</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> colors,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="st">"Trining time for each model"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Models"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Time (seconds)"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">width =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Report_new_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Generally, SVM and Ridge Regression performs best in terms of RMSE. If computation time is a concern, Ridge Regression could be a better choice.</p>
</section>
<section id="b.-deployment" class="level3">
<h3 class="anchored" data-anchor-id="b.-deployment">B. Deployment</h3>
<p>Before analyzing each stock data provided by Optiver, our group separated the datasets into different clusters. Because different stocks can have very different charateristics, clustering helps to identify these differences so that we can analyse the clusters individually and find the best model for a particular type of stock.&nbsp; Given the financial nature of the datasets, our group decided to use liquidity - one of the most important metrics in stock trading - for clustering.[1] Liquidity measures how rapidly a stock can be bought or sold without significantly impacting its price, and we used the following formula to calculate liquidity:</p>
<p>liquidity= sum(mean(bid_size1),mean(bid_size2),mean(ask_size1),mean(ask_size2))</p>
<p>All data sets were clustered using liquidity as the metrics and K-means as the clustering method. We first selected 5 stocks with extremely high volatilities as outliers and categorised them into a separate cluster. Then, our group clustered the remaining stocks into 5 clusters, choosing 5 stocks from each cluster, for a total of 30 stocks to analyse. Besides the original variables, we also calculated WAP, Bidaskspread, number of orders, oversize and volatility (formulae below):</p>
<p>WAP=(bid_price1 * ask_size1 + ask_price1 * bid_size1)/(bid_size1 + ask_size1))</p>
<p>BidAskSpread = ask_price / bid_price-1</p>
<p>num_order = bid_size1 + ask_size1 + bid_size2 + ask_size2</p>
<p>over_bid = sum(bid_size1) +sum(bid_size2)-sum(ask_size1)-sum(ask_size2)</p>
<p>volatility= √(〖sum(log⁡return)〗^2 )</p>
<p>Since time id’s are not sequential while seconds in time id’s are sequential, our group divided the time within a time id to time intervals and calculated volatilities for each time interval. Each time id is roughly 600 seconds, with each time interval 30 seconds. After training and testing the model, our group calculated RMSE based on their data and organised the results into box-plots that are categorized according to different clusters and models. (Formula of RMSE shown below):</p>
<p>RMSE= √(〖mean((predicted -actual)〗^2))&nbsp;</p>
<p>We communicate our group’s product using R shiny app. Based on user’s input, the app can display the RMSE boxplots of the 6 models for each cluster or a prediction vs actual plot of volatilises for the best model of the cluster. To help traders interpreting the model, we included a short description of the best model’s working principles and justifications of why it is selected. Furthermore, the shiny app includes interactive feature that allows user to upload a stock csv file and predict volatilities immediately. The app will show the stock’s liquidity, its assigned cluster based on liquidity, and using the best model for the particular cluster, our shiny app will produce a prediction vs actual plot generated from the selected model. This feature allows traders to directly assess our model’s performance, thus assisting them to make decision on whether the model should be used.</p>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>Our group identifies three main shortcomings of our project and final product. First, our project is much more focused on the data science discipline, neglecting the implications of financial knowledge. For example, we use only one method of calculating volatility, namely the standard deviation of returns, without considering other methods like beta coefficient. This potentially leads to differences in our final evaluation of models as our models’ performance may change depending on the method of volatility used. Second, our clustering of the dataset is possibly futile from hindsight. We clustered the stocks using liquidity; however, after evaluation, SVM(Support Vector Machine) ends up being the best model for the majority of the clusters. A potential reason for this is that our clustering is based on only one variable, i.e.&nbsp;liquidity, ignoring other characteristics of a stock. A better clustering using more variables can produce a different set of clusters, thus resulting in different model performance and final evaluation. Third, our group did not use feature selection, and we could have used selection criteria like AIC or BIC to choose the most important features. Such selection can reduce our training time, and potentially change our model performance, leading to different evaluation results.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The aim of our project is to develop and communicate a model that accurately predicts stock volatility and can be interpreted clearly by traders. After initial preliminary calculations on the datasets, we organised them into six clusters and used six different models - ARMA-GARCH, SVM, Regression, HAR-RV, LSTM and Random Forest - for evaluation. Using RMSE as our main evaluation metric, we found the best models for each cluster and effectively communicated our findings using an illustrative ShinyApp. For future improvements, our group identified at least three areas:</p>
<ol type="1">
<li><p>Using different methods of calculating volatility for comparison.</p></li>
<li><p>Clustering the datasets using more features of the stocks.</p></li>
<li><p>Feature selection of the variables used for training the models.</p></li>
</ol>
<p>We believe that these future works will improve our model performance.</p>
</section>
<section id="student-contributions" class="level2">
<h2 class="anchored" data-anchor-id="student-contributions">Student Contributions</h2>
<p>Aim &amp; background: Baiyu Method A: everyone (do own model) Method B: Isabella Results A: Derek &amp; Tom Results B: Yuxiang Discussion and conclusion: Alan</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>[1] Ben R. Marshall, Martin Young Liquidity and stock returns in pure order-driven markets: evidence from the Australian stock market (2003) https://doi.org/10.1016/S1057-5219(03)00006-1</p>
<p>[2] ALLAUDEEN HAMEED, WENJIN KANG, S. VISWANATHAN Stock Market Declines and Liquidity (2010)<a href="https://doi.org/10.1111/j.1540-6261.2009.01529.x" class="uri">https://doi.org/10.1111/j.1540-6261.2009.01529.x</a>&nbsp;</p>
<p>[3] Hong Zhang, Yaobin Lu, Sumeet Gupta, Ling Zhao What motivates customers to participate in social commerce? The impact of technological environments and virtual customer experiences (2014) https://doi.org/10.1016/j.im.2014.07.005</p>
<p>[4] Wei Liu and Bruce Morley, ‘Volatility in the Hang Seng Index using the GARCH Approach’, Asia-Pacific Financial Markets 16:51-63 (2009) https://doi.org/10.1007/s10690-009-9086-4</p>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<ol type="1">
<li>Here is the coding part for clustering stocks, stock selection, process of SVM model and production of RMSE box plots.</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare work for clustering</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="st">"./data3888/Optiver/individual_book_train"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="st">'./data3888/Optiver/individual_book_train'</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the list of file names in the directory</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>file_names <span class="ot">&lt;-</span> <span class="fu">list.files</span>(path, <span class="at">pattern =</span> <span class="st">".csv"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>liquidity <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each file, read it into a data frame, and add it to the list</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> file_names) {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> names[n]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> n<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  dff <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store stock names</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  dff[<span class="st">'name'</span>] <span class="ot">&lt;-</span> name</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate liquidity for each stock </span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  dff[<span class="st">'liquidity'</span>] <span class="ot">&lt;-</span><span class="fu">round</span>(<span class="fu">sum</span>(<span class="fu">mean</span>(df<span class="sc">$</span>bid_size1), <span class="fu">mean</span>(df<span class="sc">$</span>bid_size2),<span class="fu">mean</span>(df<span class="sc">$</span>ask_size1),<span class="fu">mean</span>(df<span class="sc">$</span>ask_size2)),<span class="dv">0</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  liquidity <span class="ot">&lt;-</span> <span class="fu">rbind</span>(liquidity,dff)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>liquidity <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(liquidity)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># load the liquidity file</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'liquidity edited.csv'</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Use kmean to cluster</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>kmeans <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(l[<span class="dv">2</span>], <span class="at">centers =</span> <span class="dv">5</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>samples_per_cluster <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>cluster_labels <span class="ot">&lt;-</span> kmeans<span class="sc">$</span>cluster</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty list to store selected samples</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>selected_samples <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each cluster</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract samples belonging to the current cluster</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  current_cluster_samples <span class="ot">&lt;-</span> l[cluster_labels <span class="sc">==</span> i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Randomly select samples from the current cluster</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> current_cluster_samples[<span class="fu">sample</span>(<span class="fu">nrow</span>(current_cluster_samples), samples_per_cluster), , drop <span class="ot">=</span> T]</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  temp[<span class="st">'cluster'</span>] <span class="ot">&lt;-</span> i</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  selected_samples <span class="ot">&lt;-</span> <span class="fu">rbind</span>(selected_samples,temp)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the selected samples from all clusters into a single matrix</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>selected_samples <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, selected_samples)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>selected_samples <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(selected_samples)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>square <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="co">#make a function for calculate RMSE</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>Derek <span class="ot">&lt;-</span> <span class="cf">function</span>(path,c) {</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data prepare </span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(path)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>                             ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>                      (bid_size1 <span class="sc">+</span>   ask_size1))</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BidAskSpread =</span> </span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>                         ask_price1 <span class="sc">/</span> bid_price1 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span>  <span class="fu">mutate</span>(<span class="at">time_bucket =</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">ceiling</span>(seconds_in_bucket <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>  lr <span class="ot">&lt;-</span> <span class="fu">c</span>(data<span class="sc">$</span>WAP[<span class="dv">1</span>],<span class="fu">diff</span>(<span class="fu">log</span>(data<span class="sc">$</span>WAP)))</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  lr <span class="ot">=</span> <span class="fu">as.data.frame</span>(lr)</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data,lr)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  id <span class="ot">&lt;-</span> <span class="fu">unique</span>(data<span class="sc">$</span>time_id)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(c)</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  selected_id <span class="ot">=</span> <span class="fu">sample</span>(id, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> F)</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Train a model for each time id</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(selected_id)){</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> selected_id[i])</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">=</span> d[<span class="sc">-</span><span class="dv">1</span>,]</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    time <span class="ot">&lt;-</span> <span class="fu">unique</span>(d<span class="sc">$</span>time_bucket)</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Take variables we need for training </span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(time)){</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>      dt <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_bucket <span class="sc">==</span> time[y])</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>      df[<span class="st">'time_id'</span>] <span class="ot">=</span> selected_id[i]</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>      df[<span class="st">'time_bucket'</span>] <span class="ot">=</span> time[y]</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>      df[<span class="st">'mean_WAP'</span>] <span class="ot">=</span> <span class="fu">mean</span>(dt<span class="sc">$</span>WAP)</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>      df[<span class="st">'mean_spread'</span>] <span class="ot">=</span> <span class="fu">mean</span>(dt<span class="sc">$</span>BidAskSpread)</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>      df[<span class="st">'voladility'</span>] <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(<span class="fu">square</span>(dt<span class="sc">$</span>lr)))</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">=</span> <span class="fu">t</span>(df)</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">=</span> <span class="fu">as.data.frame</span>(df) </span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>      k <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df,k)</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">&lt;-</span> k[<span class="fu">order</span>(k<span class="sc">$</span>time_bucket),]</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    i_d <span class="ot">=</span> k<span class="sc">$</span>time_id[<span class="dv">1</span>]</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">=</span> k[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start to train</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    train_control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"timeslice"</span>,</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">initialWindow =</span> <span class="dv">4</span>,  </span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">horizon =</span> <span class="dv">1</span>,  </span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">fixedWindow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    svm_model <span class="ot">&lt;-</span> <span class="fu">train</span>(voladility <span class="sc">~</span> ., <span class="at">data =</span> k, <span class="at">method =</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"svmRadial"</span>, <span class="at">trControl =</span>train_control)</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Take the RMSE</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">=</span> <span class="fu">data.frame</span>(i_d, svm_model<span class="sc">$</span>results<span class="sc">$</span>RMSE[<span class="dv">1</span>])</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">=</span> <span class="fu">rbind</span>(results,result)</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Get RMSEs for each cluster and prepare data for creating Boxplots</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Read cluster file we got from kmeans</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>cluster <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'sample select.csv'</span>)</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(cluster<span class="sc">$</span>cluster))</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>df_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Go through each cluster</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>    select <span class="ot">&lt;-</span> cluster <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cluster <span class="sc">==</span> i)</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(i)</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Go through each stock we randomly picked from each cluster</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (p <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(select<span class="sc">$</span>X)) {</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>      path <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">'./data3888/Optiver/individual_book_train/'</span>,select<span class="sc">$</span>X[p], <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Get RMSE in the cluster</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>      rmse <span class="ot">&lt;-</span> <span class="fu">Derek</span>(path,i)</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>      rmse[<span class="st">'Name'</span>] <span class="ot">=</span> select<span class="sc">$</span>X[p]</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>      final <span class="ot">=</span> <span class="fu">rbind</span>(final,rmse) </span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>    df_list[[i]] <span class="ot">=</span> final</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write them as CSV</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(df_list)) {</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(df_list[[i]], <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"df"</span>, i, <span class="st">".csv"</span>), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Coding for LSTM</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Library</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="do">### Read data</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>sample_select <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"dataset/sample_select.csv"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="do">### get data from the csv file</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a list to store the data from the X column files</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each row of the sample_select data frame</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(sample_select)) {</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the data path from the X column</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  path <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">"dataset/individual_book_train/"</span>, sample_select<span class="sc">$</span>X[i], <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the data from the data path</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(path)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the data and corresponding cluster value to the data_list</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  data_list[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">data =</span> data, <span class="at">cluster =</span> sample_select<span class="sc">$</span>cluster[i])</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="do">### split the value into different cluster</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty named list to store the merged data for each unique cluster</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>unique_clusters <span class="ot">&lt;-</span> <span class="fu">unique</span>(sample_select<span class="sc">$</span>cluster)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>merged_data_list <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">lapply</span>(unique_clusters, <span class="cf">function</span>(x) <span class="cn">NULL</span>), <span class="fu">as.character</span>(unique_clusters))</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each data item in data_list</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(data_list)) {</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the cluster value</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  cluster <span class="ot">&lt;-</span> data_list[[i]]<span class="sc">$</span>cluster</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the current cluster data frame is empty in merged_data_list</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(merged_data_list[[<span class="fu">as.character</span>(cluster)]])) {</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the merged_data_list with the first data frame for the cluster</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    merged_data_list[[<span class="fu">as.character</span>(cluster)]] <span class="ot">&lt;-</span> data_list[[i]]<span class="sc">$</span>data</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge the data using bind_rows()</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    merged_data_list[[<span class="fu">as.character</span>(cluster)]] <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(merged_data_list[[<span class="fu">as.character</span>(cluster)]],</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>                                                            data_list[[i]]<span class="sc">$</span>data)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="do">### randomly select the time id from each cluster</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co">#Cluster1</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>random_time_cluster1 <span class="ot">&lt;-</span> <span class="fu">sample</span>(merged_data_list[[<span class="dv">1</span>]]<span class="sc">$</span>time_id, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="do">## Cluster2 </span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>random_time_cluster2 <span class="ot">&lt;-</span> <span class="fu">sample</span>(merged_data_list[[<span class="dv">2</span>]]<span class="sc">$</span>time_id, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="do">## Cluster3</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>random_time_cluster3 <span class="ot">&lt;-</span> <span class="fu">sample</span>(merged_data_list[[<span class="dv">3</span>]]<span class="sc">$</span>time_id, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="do">## Cluster4</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>random_time_cluster4 <span class="ot">&lt;-</span> <span class="fu">sample</span>(merged_data_list[[<span class="dv">4</span>]]<span class="sc">$</span>time_id, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a><span class="do">## Cluster5</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5</span>)</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>random_time_cluster5 <span class="ot">&lt;-</span> <span class="fu">sample</span>(merged_data_list[[<span class="dv">5</span>]]<span class="sc">$</span>time_id, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">6</span>)</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>random_time_cluster6 <span class="ot">&lt;-</span> <span class="fu">sample</span>(merged_data_list[[<span class="dv">6</span>]]<span class="sc">$</span>time_id, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="do">### Select the value based on the time id</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>get_data <span class="ot">&lt;-</span> <span class="cf">function</span>(cluster_index, random_time_id) {</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  selected_cluster <span class="ot">&lt;-</span> merged_data_list[[cluster_index]][merged_data_list[[cluster_index]]<span class="sc">$</span>time_id <span class="sc">%in%</span> random_time_id, ]</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>  group_size <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>  selected_rows_ <span class="ot">&lt;-</span> selected_cluster <span class="sc">%&gt;%</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group_id =</span> (seconds_in_bucket) <span class="sc">%/%</span> group_size <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>  mean_cluster <span class="ot">&lt;-</span> selected_rows_ <span class="sc">%&gt;%</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(stock_id, time_id, group_id) <span class="sc">%&gt;%</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(<span class="st">"seconds_in_bucket"</span>, <span class="st">"bid_price1"</span>, <span class="st">"ask_price1"</span>, <span class="st">"bid_price2"</span>, <span class="st">"ask_price2"</span>, <span class="st">"bid_size1"</span>, <span class="st">"ask_size1"</span>, <span class="st">"bid_size2"</span>, <span class="st">"ask_size2"</span>, ), mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mean_cluster)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a><span class="do">### Get all the data for each cluster</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>mean_cluster1 <span class="ot">=</span> <span class="fu">get_data</span>(<span class="dv">1</span>, random_time_cluster1)</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>mean_cluster2 <span class="ot">=</span> <span class="fu">get_data</span>(<span class="dv">2</span>, random_time_cluster2)</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>mean_cluster3 <span class="ot">=</span> <span class="fu">get_data</span>(<span class="dv">3</span>, random_time_cluster3)</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>mean_cluster4 <span class="ot">=</span> <span class="fu">get_data</span>(<span class="dv">4</span>, random_time_cluster4)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>mean_cluster5 <span class="ot">=</span> <span class="fu">get_data</span>(<span class="dv">5</span>, random_time_cluster5)</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>mean_cluster6 <span class="ot">=</span> <span class="fu">get_data</span>(<span class="dv">6</span>, random_time_cluster6)</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="do">### Data to File</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(mean_cluster1, <span class="st">"dataset/cluster1_data.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(mean_cluster2, <span class="st">"dataset/cluster2_data.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(mean_cluster3, <span class="st">"dataset/cluster3_data.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(mean_cluster4, <span class="st">"dataset/cluster4_data.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(mean_cluster5, <span class="st">"dataset/cluster5_data.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(mean_cluster6, <span class="st">"dataset/cluster6_data.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a><span class="do">### Load the data from file</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>mean_cluster1 <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"dataset/cluster1_data.csv"</span>)</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>mean_cluster2 <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"dataset/cluster2_data.csv"</span>)</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>mean_cluster3 <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"dataset/cluster3_data.csv"</span>)</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>mean_cluster4 <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"dataset/cluster4_data.csv"</span>)</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>mean_cluster5 <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"dataset/cluster5_data.csv"</span>)</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>mean_cluster6 <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"dataset/cluster6_data.csv"</span>)</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a><span class="do">### Calculate the volatility</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>cal_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate WAP</span></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>  mean_cluster_copy <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span> ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span> (bid_size1 <span class="sc">+</span> ask_size1))</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the log return of WAP</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>  mean_cluster_copy <span class="ot">&lt;-</span> mean_cluster_copy <span class="sc">%&gt;%</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(stock_id, time_id) <span class="sc">%&gt;%</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">LogReturn =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(<span class="fu">log</span>(WAP)))) <span class="sc">%&gt;%</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(stock_id, time_id, group_id)</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate volatility</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>  mean_cluster_copy <span class="ot">&lt;-</span> mean_cluster_copy <span class="sc">%&gt;%</span></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(stock_id, time_id, group_id) <span class="sc">%&gt;%</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Volatility =</span> <span class="fu">comp_vol</span>(LogReturn))</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mean_cluster_copy)</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a><span class="do">###    Assign the volality value to each cluster</span></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>cluster1_vol <span class="ot">=</span> <span class="fu">cal_vol</span>(mean_cluster1)</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>cluster2_vol <span class="ot">=</span> <span class="fu">cal_vol</span>(mean_cluster2)</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>cluster3_vol <span class="ot">=</span> <span class="fu">cal_vol</span>(mean_cluster3)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>cluster4_vol <span class="ot">=</span> <span class="fu">cal_vol</span>(mean_cluster4)</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>cluster5_vol <span class="ot">=</span> <span class="fu">cal_vol</span>(mean_cluster5)</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>cluster6_vol <span class="ot">=</span> <span class="fu">cal_vol</span>(mean_cluster6)</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a><span class="do">### get the train data</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>get_train_data <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>  split_index <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(df<span class="sc">$</span>Volatility, <span class="at">p =</span> <span class="fl">0.8</span>, <span class="at">list =</span> <span class="cn">FALSE</span>, <span class="at">times =</span> <span class="dv">1</span>)</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> df[split_index, ]</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> df[<span class="sc">-</span>split_index, ]</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>  timesteps <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>  n_features <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>  x_train <span class="ot">&lt;-</span> train_data[, <span class="fu">c</span>(<span class="st">"LogReturn"</span>, <span class="st">"WAP"</span>, <span class="st">"bid_price1"</span>, <span class="st">"ask_size1"</span>, <span class="st">"bid_size1"</span>)]</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>  y_train <span class="ot">&lt;-</span> train_data[,<span class="st">"Volatility"</span>]</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>  x_train_array <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(x_train)</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>  y_train_array <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(y_train)</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>  x_train_reshaped <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(x_train_array, <span class="fu">c</span>(<span class="fu">nrow</span>(x_train), timesteps, n_features))</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Preprocess the test data</span></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>  x_test <span class="ot">&lt;-</span> test_data[, <span class="fu">c</span>(<span class="st">"LogReturn"</span>, <span class="st">"WAP"</span>, <span class="st">"bid_price1"</span>, <span class="st">"ask_size1"</span>, <span class="st">"bid_size1"</span>)]</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>  y_test <span class="ot">&lt;-</span> test_data[,<span class="st">"Volatility"</span>]</span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>  x_test_array <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(x_test)</span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>  y_test_array <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(y_test)</span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>  x_test_reshaped <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(x_test_array, <span class="fu">c</span>(<span class="fu">nrow</span>(x_test), timesteps, n_features))</span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">list</span>(train_data, test_data, x_train_reshaped, y_train_array, x_test_reshaped, y_test_array)</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a><span class="do">### Train and test data</span></span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>cluster1_output <span class="ot">=</span> <span class="fu">get_train_data</span>(cluster1_vol)</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>cluster1_train <span class="ot">=</span> <span class="fu">data.frame</span>(cluster1_output[<span class="dv">1</span>])</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>cluster1_test <span class="ot">=</span> <span class="fu">data.frame</span>(cluster1_output[<span class="dv">2</span>])</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>cluster1_x_train <span class="ot">=</span> cluster1_output[<span class="dv">3</span>]</span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>cluster1_y_train <span class="ot">=</span> cluster1_output[<span class="dv">4</span>]</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>cluster1_x_test <span class="ot">=</span> cluster1_output[<span class="dv">5</span>]</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>cluster1_y_test <span class="ot">=</span> cluster1_output[<span class="dv">6</span>]</span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>cluster2_output <span class="ot">=</span> <span class="fu">get_train_data</span>(cluster2_vol)</span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>cluster2_train <span class="ot">=</span> <span class="fu">data.frame</span>(cluster2_output[<span class="dv">1</span>])</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>cluster2_test <span class="ot">=</span> <span class="fu">data.frame</span>(cluster2_output[<span class="dv">2</span>])</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>cluster2_x_train <span class="ot">=</span> cluster2_output[<span class="dv">3</span>]</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>cluster2_y_train <span class="ot">=</span> cluster2_output[<span class="dv">4</span>]</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>cluster2_x_test <span class="ot">=</span> cluster2_output[<span class="dv">5</span>]</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>cluster2_y_test <span class="ot">=</span> cluster2_output[<span class="dv">6</span>]</span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>cluster3_output <span class="ot">=</span> <span class="fu">get_train_data</span>(cluster3_vol)</span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>cluster3_train <span class="ot">=</span> <span class="fu">data.frame</span>(cluster3_output[<span class="dv">1</span>])</span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>cluster3_test <span class="ot">=</span> <span class="fu">data.frame</span>(cluster3_output[<span class="dv">2</span>])</span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>cluster3_x_train <span class="ot">=</span> cluster3_output[<span class="dv">3</span>]</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>cluster3_y_train <span class="ot">=</span> cluster3_output[<span class="dv">4</span>]</span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>cluster3_x_test <span class="ot">=</span> cluster3_output[<span class="dv">5</span>]</span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>cluster3_y_test <span class="ot">=</span> cluster3_output[<span class="dv">6</span>]</span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>cluster4_output <span class="ot">=</span> <span class="fu">get_train_data</span>(cluster4_vol)</span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>cluster4_train <span class="ot">=</span> <span class="fu">data.frame</span>(cluster4_output[<span class="dv">1</span>])</span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>cluster4_test <span class="ot">=</span> <span class="fu">data.frame</span>(cluster4_output[<span class="dv">2</span>])</span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>cluster4_x_train <span class="ot">=</span> cluster4_output[<span class="dv">3</span>]</span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>cluster4_y_train <span class="ot">=</span> cluster4_output[<span class="dv">4</span>]</span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>cluster4_x_test <span class="ot">=</span> cluster4_output[<span class="dv">5</span>]</span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>cluster4_y_test <span class="ot">=</span> cluster4_output[<span class="dv">6</span>]</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>cluster5_output <span class="ot">=</span> <span class="fu">get_train_data</span>(cluster5_vol)</span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>cluster5_train <span class="ot">=</span> <span class="fu">data.frame</span>(cluster5_output[<span class="dv">1</span>])</span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>cluster5_test <span class="ot">=</span> <span class="fu">data.frame</span>(cluster5_output[<span class="dv">2</span>])</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>cluster5_x_train <span class="ot">=</span> cluster5_output[<span class="dv">3</span>]</span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>cluster5_y_train <span class="ot">=</span> cluster5_output[<span class="dv">4</span>]</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>cluster5_x_test <span class="ot">=</span> cluster5_output[<span class="dv">5</span>]</span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>cluster5_y_test <span class="ot">=</span> cluster5_output[<span class="dv">6</span>]</span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>cluster6_output <span class="ot">=</span> <span class="fu">get_train_data</span>(cluster6_vol)</span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>cluster6_train <span class="ot">=</span> <span class="fu">data.frame</span>(cluster6_output[<span class="dv">1</span>])</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>cluster6_test <span class="ot">=</span> <span class="fu">data.frame</span>(cluster6_output[<span class="dv">2</span>])</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>cluster6_x_train <span class="ot">=</span> cluster6_output[<span class="dv">3</span>]</span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>cluster6_y_train <span class="ot">=</span> cluster6_output[<span class="dv">4</span>]</span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>cluster6_x_test <span class="ot">=</span> cluster6_output[<span class="dv">5</span>]</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>cluster6_y_test <span class="ot">=</span> cluster6_output[<span class="dv">6</span>]</span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a><span class="do">### Train the model with each cluster</span></span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>train_test_model <span class="ot">&lt;-</span> <span class="cf">function</span>(test_data, x_train, y_train, x_test, y_test) {</span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define RMSE metric</span></span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">custom_metric</span>(<span class="st">"rmse"</span>, <span class="cf">function</span>(y_true, y_pred) {</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>    <span class="fu">k_sqrt</span>(<span class="fu">k_mean</span>(<span class="fu">k_square</span>(y_pred <span class="sc">-</span> y_true), <span class="at">axis =</span> <span class="sc">-</span>1L))</span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specify model architecture</span></span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_lstm</span>(<span class="at">units =</span> <span class="dv">50</span>, <span class="at">return_sequences =</span> <span class="cn">TRUE</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_lstm</span>(<span class="at">units =</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>)</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compile the model</span></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>  model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss =</span> <span class="st">'mse'</span>,</span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> <span class="st">'adam'</span>,</span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">list</span>(<span class="st">"mean_absolute_error"</span>, rmse)</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>  history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>  x_train, y_train,</span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">10</span>, <span class="at">batch_size =</span> <span class="dv">2</span>, </span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span></span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">predict</span>(x_test)</span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>  y_test <span class="ot">&lt;-</span> <span class="fu">unlist</span>(y_test)</span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>  y_test <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(y_test)</span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate MSE and RMSE</span></span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a>  cluster_result <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> (y_test <span class="sc">-</span> predictions) <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE =</span> <span class="fu">sqrt</span>((y_test <span class="sc">-</span> predictions) <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>    <span class="at">R_squared =</span> <span class="fu">cor</span>(predictions, y_test)<span class="sc">^</span><span class="dv">2</span>, </span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">qlike =</span> <span class="fu">mean</span>(y_test<span class="sc">/</span>predictions <span class="sc">-</span> <span class="fu">log</span>(y_test<span class="sc">/</span>predictions) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add time_id and stock_id to results</span></span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>  cluster_result <span class="ot">&lt;-</span> cluster_result <span class="sc">%&gt;%</span></span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(time_id <span class="ot">&lt;-</span> test_data<span class="sc">$</span>time_id)</span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>  cluster_result <span class="ot">&lt;-</span> cluster_result <span class="sc">%&gt;%</span></span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(stock_id <span class="ot">&lt;-</span> test_data<span class="sc">$</span>stock_id)</span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(cluster_result)</span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">list</span>(cluster_result, model)</span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a><span class="do">### Results of each cluster</span></span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>cluster1_result_output <span class="ot">=</span> <span class="fu">train_test_model</span>(cluster1_test, cluster1_x_train, cluster1_y_train, cluster1_x_test, cluster1_y_test)</span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>cluster1_result <span class="ot">=</span> <span class="fu">data.frame</span>(cluster1_result_output[<span class="dv">1</span>])</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>cluster1_model <span class="ot">=</span> cluster1_result_output[<span class="dv">2</span>]</span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>cluster2_result_output <span class="ot">=</span> <span class="fu">train_test_model</span>(cluster2_test, cluster2_x_train, cluster2_y_train, cluster2_x_test, cluster2_y_test)</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>cluster2_result <span class="ot">=</span> <span class="fu">data.frame</span>(cluster2_result_output[<span class="dv">1</span>])</span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>cluster2_model <span class="ot">=</span> cluster2_result_output[<span class="dv">2</span>]</span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>cluster3_result_output <span class="ot">=</span> <span class="fu">train_test_model</span>(cluster3_test, cluster3_x_train, cluster3_y_train, cluster3_x_test, cluster3_y_test)</span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>cluster3_result <span class="ot">=</span> <span class="fu">data.frame</span>(cluster3_result_output[<span class="dv">1</span>])</span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>cluster3_model <span class="ot">=</span> cluster3_result_output[<span class="dv">2</span>]</span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>cluster4_result_output <span class="ot">=</span> <span class="fu">train_test_model</span>(cluster4_test, cluster4_x_train, cluster4_y_train, cluster4_x_test, cluster4_y_test)</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>cluster4_result <span class="ot">=</span> <span class="fu">data.frame</span>(cluster4_result_output[<span class="dv">1</span>])</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>cluster4_model <span class="ot">=</span> cluster4_result_output[<span class="dv">2</span>]</span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>cluster5_result_output <span class="ot">=</span> <span class="fu">train_test_model</span>(cluster5_test, cluster5_x_train, cluster5_y_train, cluster5_x_test, cluster5_y_test)</span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>cluster5_result <span class="ot">=</span> <span class="fu">data.frame</span>(cluster5_result_output[<span class="dv">1</span>])</span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>cluster5_model <span class="ot">=</span> cluster5_result_output[<span class="dv">2</span>]</span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>cluster6_result_output <span class="ot">=</span> <span class="fu">train_test_model</span>(cluster6_test, cluster6_x_train, cluster6_y_train, cluster6_x_test, cluster6_y_test)</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>cluster6_result <span class="ot">=</span> <span class="fu">data.frame</span>(cluster6_result_output[<span class="dv">1</span>])</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>cluster6_model <span class="ot">=</span> cluster6_result_output[<span class="dv">2</span>]</span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a><span class="do">### Results</span></span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind the data for all clusters together</span></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>cluster1_result<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="st">"cluster1"</span></span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>cluster2_result<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="st">"cluster2"</span></span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a>cluster3_result<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="st">"cluster3"</span></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>cluster4_result<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="st">"cluster4"</span></span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>cluster5_result<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="st">"cluster5"</span></span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a>cluster6_result<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="st">"cluster6"</span></span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(cluster1_result, cluster2_result, cluster3_result, cluster4_result, cluster5_result, cluster6_result)</span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape data to a long format</span></span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>all_results_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(all_results, <span class="at">id.vars =</span> <span class="fu">c</span>(<span class="st">"cluster"</span>))</span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a><span class="co"># Create boxplot for MSE</span></span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>mse_results <span class="ot">&lt;-</span> all_results_long[all_results_long<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"MSE"</span>, ]</span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mse_results, <span class="fu">aes</span>(<span class="at">x =</span> cluster, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"MSE"</span>, <span class="at">title =</span> <span class="st">"Boxplot of MSE for All Clusters"</span>)</span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Create boxplot for RMSE</span></span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>rmse_results <span class="ot">&lt;-</span> all_results_long[all_results_long<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"RMSE"</span>, ]</span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rmse_results, <span class="fu">aes</span>(<span class="at">x =</span> cluster, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"RMSE"</span>, <span class="at">title =</span> <span class="st">"Boxplot of RMSE for All Clusters"</span>)</span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a><span class="do">### Write the result to CSV file</span></span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(cluster1_result, <span class="st">"result/cluster1_LSTM_rmse.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(cluster2_result, <span class="st">"result/cluster2_LSTM_rmse.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(cluster3_result, <span class="st">"result/cluster3_LSTM_rmse.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(cluster4_result, <span class="st">"result/cluster4_LSTM_rmse.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(cluster5_result, <span class="st">"result/cluster5_LSTM_rmse.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(cluster6_result, <span class="st">"result/cluster6_LSTM_rmse.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a><span class="do">### Combine into one file</span></span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a unique identifier within each cluster</span></span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a>group_cluster_results <span class="ot">&lt;-</span> all_results <span class="sc">%&gt;%</span></span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot your dataframe</span></span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a>RMSE_cluster_results <span class="ot">&lt;-</span> group_cluster_results <span class="sc">%&gt;%</span></span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> cluster, <span class="at">values_from =</span> RMSE, <span class="at">id_cols =</span> id) <span class="sc">%&gt;%</span></span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">"cluster1"</span>, <span class="st">"cluster2"</span>, <span class="st">"cluster3"</span>, <span class="st">"cluster4"</span>, <span class="st">"cluster5"</span>, <span class="st">"cluster6"</span>)</span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot your dataframe</span></span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>R_squared_cluster_results <span class="ot">&lt;-</span> group_cluster_results <span class="sc">%&gt;%</span></span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> cluster, <span class="at">values_from =</span> R_squared, <span class="at">id_cols =</span> id) <span class="sc">%&gt;%</span></span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">"cluster1"</span>, <span class="st">"cluster2"</span>, <span class="st">"cluster3"</span>, <span class="st">"cluster4"</span>, <span class="st">"cluster5"</span>, <span class="st">"cluster6"</span>)</span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>R_squared_cluster_results</span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(RMSE_cluster_results, <span class="st">"result/all_cluster_LSTM.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(R_squared_cluster_results, <span class="st">"result/LSTM_R_SQUARED.csv"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Coding for Ridge regression</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rugarch)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kernlab)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stats)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stats)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantreg)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Metrics)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Default, <span class="at">package =</span> <span class="st">"ISLR"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>dir1 <span class="ot">&lt;-</span> <span class="st">"Cluster 1"</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>cluster1 <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir1)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>dir2 <span class="ot">&lt;-</span> <span class="st">"Cluster 2"</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>cluster2 <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir2)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>dir3 <span class="ot">&lt;-</span> <span class="st">"Cluster 3"</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>cluster3 <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir3)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>dir4 <span class="ot">&lt;-</span> <span class="st">"Cluster 4"</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>cluster4 <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir4)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>dir5 <span class="ot">&lt;-</span> <span class="st">"Cluster 5"</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>cluster5 <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir5)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>dir6 <span class="ot">&lt;-</span> <span class="st">"Clsuter outlier"</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>cluster6 <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir6)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>total_mse1 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>mse_list1 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>mse_list2 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>mse_list3 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>mse_list4 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>mse_list5 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>mse_list6 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>count <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>stock_file1 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> cluster1) {</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  stock_file1[[i]] <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(dir1, i))</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>stock_file2 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> cluster2) {</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  stock_file2[[i]] <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(dir2, i))</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>stock_file3 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> cluster3) {</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  stock_file3[[i]] <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(dir3, i))</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>stock_file4 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> cluster4) {</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  stock_file4[[i]] <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(dir4, i))</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>stock_file5 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> cluster5) {</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>  stock_file5[[i]] <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(dir5, i))</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>stock_file6 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> cluster6) {</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  stock_file6[[i]] <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(dir6, i))</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>count <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>total_mse1 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>mse_list11 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>mse_list12 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>mse_list13 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>mse_list14 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>mse_list15 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(stock_file1)){</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>  count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> stock_file1[[i]]</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span> ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span> (bid_size1 <span class="sc">+</span> ask_size1))</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BidAskSpread1 =</span> ask_price1 <span class="sc">/</span> bid_price1 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">#temporary &lt;- temporary %&gt;% mutate(BidAskSpread2 = ask_price2 / bid_price2 - 1)</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">num_order =</span> bid_size1 <span class="sc">+</span> ask_size1 <span class="sc">+</span> bid_size2 <span class="sc">+</span> ask_size2)</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>  log_r1 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>  time_IDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(temporary[, <span class="dv">1</span>])</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>  sample_time_id <span class="ot">=</span> <span class="fu">sample</span>(time_IDs, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(sample_time_id)) {</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>    sec <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(seconds_in_bucket) <span class="co">#对于sample_time_id             中的每个元素，获取 stock1 数据集中 time_id 列等于该元素的行的秒数。</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>    BS1 <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(BidAskSpread1)</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">#BS2 &lt;- temporary %&gt;% filter(time_id == sample_time_id[a]) %&gt;% pull(BidAskSpread2)</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    order <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(num_order)</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>    price <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(WAP) </span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    log_r <span class="ot">&lt;-</span> <span class="fu">log</span>(price[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> price[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(price) <span class="sc">-</span> <span class="dv">1</span>)]) <span class="co">#使用所选行的 WAP 列计算对数收益率</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> sec[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>                              <span class="at">price =</span> price[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>                              <span class="at">BidAskSpread1=</span> BS1[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#BidAskSpread2 = BS2[-1],</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>                              <span class="at">num_order =</span> order[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>                              <span class="at">log_return =</span> log_r)<span class="co">#将对数收益率存储在一个名为 log_r1 的列表中。</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    time.no.change <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>)[<span class="sc">!</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span> <span class="sc">%in%</span> log_r1[[a]]<span class="sc">$</span>time)]</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(time.no.change) <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co">#如果所选的时间戳没有连续的秒数数据，补充缺失的秒数数据，并将对数收益率设置为 0。</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>      new.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time.no.change, <span class="at">price =</span> <span class="dv">0</span>, </span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>                           <span class="at">BidAskSpread1 =</span> <span class="dv">0</span>, </span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#BidAskSpread2 = 0, </span></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>                           <span class="at">num_order =</span> <span class="dv">0</span>, </span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>                           <span class="at">log_return =</span> <span class="dv">0</span>)</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(log_r1[[a]], new.df)</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> log_r1[[a]][<span class="fu">order</span>(log_r1[[a]]<span class="sc">$</span>time), ]</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>  vol <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>  comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>  comp_price <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>((<span class="fu">sum</span>(x))<span class="sc">/</span><span class="fu">length</span>(x))</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>    log_r1[[b]] <span class="ot">&lt;-</span> log_r1[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time_bucket =</span> <span class="fu">ceiling</span>(time <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_vol)</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(price <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(BidAskSpread1 <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>    <span class="co">#vol[[b]] &lt;- vol[[b]] %&gt;% mutate(aggregate(BidAskSpread2 ~ time_bucket, data = log_r1[[b]], FUN = comp_price))</span></span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(num_order <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(vol[[b]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, </span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'volatility'</span>,<span class="st">'price'</span>, </span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'BidAskSpread1'</span>, </span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>                            <span class="co">#'BidAskSpread2', </span></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'num_order'</span> )</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(vol)){</span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>    inTrain <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(<span class="at">y=</span>vol[[e]]<span class="sc">$</span>volatility,<span class="at">p=</span><span class="fl">0.8</span>,<span class="at">list=</span><span class="cn">FALSE</span>)</span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>    training <span class="ot">&lt;-</span> vol[[e]][inTrain, ]</span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>    testing <span class="ot">&lt;-</span> vol[[e]][<span class="sc">-</span>inTrain, ]</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>    glmnet1 <span class="ot">&lt;-</span> <span class="fu">train</span>(volatility <span class="sc">~</span> ., <span class="at">data =</span> training, <span class="at">method =</span> <span class="st">"glmnet"</span>,</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>),</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">1e-18</span>, <span class="fl">1e-10</span>, <span class="at">length =</span> <span class="dv">300</span>)))</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>                   <span class="co">#tuneGrid = expand.grid(alpha = 0, lambda = 7.61524e-05))</span></span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>    predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet1, <span class="at">newdata =</span> testing)</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>    mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((predicted <span class="sc">-</span> testing<span class="sc">$</span>volatility)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>    total_mse1 <span class="ot">&lt;-</span> <span class="fu">c</span>(total_mse1, mse)</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>      mse_list11 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list11, mse)</span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>      mse_list12 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list12, mse)</span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>      mse_list13 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list13, mse)</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">4</span>){</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>      mse_list14 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list14, mse)</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">5</span>){</span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>      mse_list15 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list15, mse)</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(total_mse1), <span class="fu">sqrt</span>(<span class="fu">mean</span>(total_mse1)))</span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(total_mse1,<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>count <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>total_mse2 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>mse_list21 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>mse_list22 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>mse_list23 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>mse_list24 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>mse_list25 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>r_squared_list <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a>qlike <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>mae_list <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(stock_file2)){</span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>  count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> stock_file2[[i]]</span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span> ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span> (bid_size1 <span class="sc">+</span> ask_size1))</span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BidAskSpread1 =</span> ask_price1 <span class="sc">/</span> bid_price1 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>  <span class="co">#temporary &lt;- temporary %&gt;% mutate(BidAskSpread2 = ask_price2 / bid_price2 - 1)</span></span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">num_order =</span> bid_size1 <span class="sc">+</span> ask_size1 <span class="sc">+</span> bid_size2 <span class="sc">+</span> ask_size2)</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a>  log_r1 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>  time_IDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(temporary[, <span class="dv">1</span>])</span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a>  sample_time_id <span class="ot">=</span> <span class="fu">sample</span>(time_IDs, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(sample_time_id)) {</span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>    sec <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(seconds_in_bucket) <span class="co">#对于sample_time_id             中的每个元素，获取 stock1 数据集中 time_id 列等于该元素的行的秒数。</span></span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a>    BS1 <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(BidAskSpread1)</span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>    <span class="co">#BS2 &lt;- temporary %&gt;% filter(time_id == sample_time_id[a]) %&gt;% pull(BidAskSpread2)</span></span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>    order <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(num_order)</span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>    price <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(WAP) </span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a>    log_r <span class="ot">&lt;-</span> <span class="fu">log</span>(price[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> price[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(price) <span class="sc">-</span> <span class="dv">1</span>)]) <span class="co">#使用所选行的 WAP 列计算对数收益率</span></span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>    log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> sec[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>                              <span class="at">price =</span> price[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a>                              <span class="at">BidAskSpread1=</span> BS1[<span class="sc">-</span><span class="dv">1</span>] , </span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#BidAskSpread2 = BS2[-1],</span></span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a>                              <span class="at">num_order =</span> order[<span class="sc">-</span><span class="dv">1</span>] ,</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a>                              <span class="at">log_return =</span> log_r)<span class="co">#将对数收益率存储在一个名为 log_r1 的列表中。</span></span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>    time.no.change <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>)[<span class="sc">!</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span> <span class="sc">%in%</span> log_r1[[a]]<span class="sc">$</span>time)]</span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(time.no.change) <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co">#如果所选的时间戳没有连续的秒数数据，补充缺失的秒数数据，并将对数收益率设置为 0。</span></span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a>      new.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time.no.change, </span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>                           <span class="at">price =</span> <span class="dv">0</span>, </span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a>                           <span class="at">BidAskSpread1 =</span> <span class="dv">0</span>, </span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#BidAskSpread2 = 0, </span></span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a>                           <span class="at">num_order =</span> <span class="dv">0</span>, </span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a>                           <span class="at">log_return =</span> <span class="dv">0</span>)</span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(log_r1[[a]], new.df)</span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> log_r1[[a]][<span class="fu">order</span>(log_r1[[a]]<span class="sc">$</span>time), ]</span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a>  vol <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a>  comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a>  comp_price <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>((<span class="fu">sum</span>(x))<span class="sc">/</span><span class="fu">length</span>(x))</span>
<span id="cb5-243"><a href="#cb5-243" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-244"><a href="#cb5-244" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb5-245"><a href="#cb5-245" aria-hidden="true" tabindex="-1"></a>    log_r1[[b]] <span class="ot">&lt;-</span> log_r1[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time_bucket =</span> <span class="fu">ceiling</span>(time <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb5-246"><a href="#cb5-246" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_vol)</span>
<span id="cb5-247"><a href="#cb5-247" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(price <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-248"><a href="#cb5-248" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(BidAskSpread1 <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-249"><a href="#cb5-249" aria-hidden="true" tabindex="-1"></a>    <span class="co">#vol[[b]] &lt;- vol[[b]] %&gt;% mutate(aggregate(BidAskSpread2 ~ time_bucket, data = log_r1[[b]], FUN = comp_price))</span></span>
<span id="cb5-250"><a href="#cb5-250" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(num_order <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-251"><a href="#cb5-251" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(vol[[b]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, </span>
<span id="cb5-252"><a href="#cb5-252" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'volatility'</span>,</span>
<span id="cb5-253"><a href="#cb5-253" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'price'</span>, </span>
<span id="cb5-254"><a href="#cb5-254" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'BidAskSpread1'</span>, </span>
<span id="cb5-255"><a href="#cb5-255" aria-hidden="true" tabindex="-1"></a>                            <span class="co">#'BidAskSpread2', </span></span>
<span id="cb5-256"><a href="#cb5-256" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'num_order'</span> )</span>
<span id="cb5-257"><a href="#cb5-257" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-258"><a href="#cb5-258" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-259"><a href="#cb5-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-260"><a href="#cb5-260" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(vol)){</span>
<span id="cb5-261"><a href="#cb5-261" aria-hidden="true" tabindex="-1"></a>    inTrain <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(<span class="at">y=</span>vol[[e]]<span class="sc">$</span>volatility,<span class="at">p=</span><span class="fl">0.8</span>,<span class="at">list=</span><span class="cn">FALSE</span>)</span>
<span id="cb5-262"><a href="#cb5-262" aria-hidden="true" tabindex="-1"></a>    training <span class="ot">&lt;-</span> vol[[e]][inTrain, ]</span>
<span id="cb5-263"><a href="#cb5-263" aria-hidden="true" tabindex="-1"></a>    testing <span class="ot">&lt;-</span> vol[[e]][<span class="sc">-</span>inTrain, ]</span>
<span id="cb5-264"><a href="#cb5-264" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-265"><a href="#cb5-265" aria-hidden="true" tabindex="-1"></a>    glmnet2 <span class="ot">&lt;-</span> <span class="fu">train</span>(volatility <span class="sc">~</span> ., <span class="at">data =</span> training, <span class="at">method =</span> <span class="st">"glmnet"</span>,</span>
<span id="cb5-266"><a href="#cb5-266" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>),</span>
<span id="cb5-267"><a href="#cb5-267" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">1e-8</span>, <span class="fl">1e-1</span>, <span class="at">length =</span> <span class="dv">300</span>)))</span>
<span id="cb5-268"><a href="#cb5-268" aria-hidden="true" tabindex="-1"></a>                   <span class="co">#tuneGrid = expand.grid(alpha = 0, lambda = seq(1e-10, 1e-3, length = 300)))#seq(0.00000001, 10, length = 300)))</span></span>
<span id="cb5-269"><a href="#cb5-269" aria-hidden="true" tabindex="-1"></a>    predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet2, <span class="at">newdata =</span> testing)</span>
<span id="cb5-270"><a href="#cb5-270" aria-hidden="true" tabindex="-1"></a>    mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((predicted <span class="sc">-</span> testing<span class="sc">$</span>volatility)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb5-271"><a href="#cb5-271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-272"><a href="#cb5-272" aria-hidden="true" tabindex="-1"></a>    corr <span class="ot">&lt;-</span> <span class="fu">cor</span>(y_ture <span class="ot">&lt;-</span> predicted, y_pred <span class="ot">&lt;-</span> testing<span class="sc">$</span>volatility)</span>
<span id="cb5-273"><a href="#cb5-273" aria-hidden="true" tabindex="-1"></a>    r_squared <span class="ot">&lt;-</span> corr<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb5-274"><a href="#cb5-274" aria-hidden="true" tabindex="-1"></a>    r_squared_list <span class="ot">&lt;-</span> <span class="fu">c</span>(r_squared_list, r_squared)</span>
<span id="cb5-275"><a href="#cb5-275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-276"><a href="#cb5-276" aria-hidden="true" tabindex="-1"></a>    qlike <span class="ot">&lt;-</span> <span class="fu">c</span>(qlike, <span class="fu">mean</span>( testing<span class="sc">$</span>volatility <span class="sc">/</span>predicted   <span class="sc">-</span> <span class="fu">log</span>(testing<span class="sc">$</span>volatility<span class="sc">/</span>predicted) <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb5-277"><a href="#cb5-277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-278"><a href="#cb5-278" aria-hidden="true" tabindex="-1"></a>    small_list <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-279"><a href="#cb5-279" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-280"><a href="#cb5-280" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(z <span class="cf">in</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)){</span>
<span id="cb5-281"><a href="#cb5-281" aria-hidden="true" tabindex="-1"></a>     small_list <span class="ot">=</span>  <span class="fu">c</span>(small_list, <span class="fu">abs</span>(predicted[[z]] <span class="sc">-</span> testing<span class="sc">$</span>volatility[[z]]))</span>
<span id="cb5-282"><a href="#cb5-282" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-283"><a href="#cb5-283" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-284"><a href="#cb5-284" aria-hidden="true" tabindex="-1"></a>    mae_list <span class="ot">&lt;-</span> <span class="fu">c</span>(mae_list, <span class="fu">mean</span>(small_list))</span>
<span id="cb5-285"><a href="#cb5-285" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-286"><a href="#cb5-286" aria-hidden="true" tabindex="-1"></a>    total_mse2 <span class="ot">&lt;-</span> <span class="fu">c</span>(total_mse2, mse)</span>
<span id="cb5-287"><a href="#cb5-287" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb5-288"><a href="#cb5-288" aria-hidden="true" tabindex="-1"></a>      mse_list21 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list21, mse)</span>
<span id="cb5-289"><a href="#cb5-289" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-290"><a href="#cb5-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb5-291"><a href="#cb5-291" aria-hidden="true" tabindex="-1"></a>      mse_list22 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list22, mse)</span>
<span id="cb5-292"><a href="#cb5-292" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-293"><a href="#cb5-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb5-294"><a href="#cb5-294" aria-hidden="true" tabindex="-1"></a>      mse_list23 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list23, mse)</span>
<span id="cb5-295"><a href="#cb5-295" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-296"><a href="#cb5-296" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">4</span>){</span>
<span id="cb5-297"><a href="#cb5-297" aria-hidden="true" tabindex="-1"></a>      mse_list24 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list24, mse)</span>
<span id="cb5-298"><a href="#cb5-298" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-299"><a href="#cb5-299" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">5</span>){</span>
<span id="cb5-300"><a href="#cb5-300" aria-hidden="true" tabindex="-1"></a>      mse_list25 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list25, mse)</span>
<span id="cb5-301"><a href="#cb5-301" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-302"><a href="#cb5-302" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-303"><a href="#cb5-303" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-304"><a href="#cb5-304" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb5-305"><a href="#cb5-305" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(total_mse2), <span class="fu">sqrt</span>(<span class="fu">mean</span>(total_mse2)), <span class="fu">mean</span>(r_squared_list, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), end_time<span class="sc">-</span>start_time, <span class="fu">mean</span>(qlike, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="fu">mean</span>(mae_list, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-306"><a href="#cb5-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-307"><a href="#cb5-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-308"><a href="#cb5-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-309"><a href="#cb5-309" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(r_squared_list, <span class="st">"r_squared.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-310"><a href="#cb5-310" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(qlike, <span class="st">"qlike.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-311"><a href="#cb5-311" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(mae_list, <span class="st">"mae.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-312"><a href="#cb5-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-313"><a href="#cb5-313" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(total_mse2,<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-314"><a href="#cb5-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-315"><a href="#cb5-315" aria-hidden="true" tabindex="-1"></a>count <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-316"><a href="#cb5-316" aria-hidden="true" tabindex="-1"></a>total_mse3 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-317"><a href="#cb5-317" aria-hidden="true" tabindex="-1"></a>mse_list31 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-318"><a href="#cb5-318" aria-hidden="true" tabindex="-1"></a>mse_list32 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-319"><a href="#cb5-319" aria-hidden="true" tabindex="-1"></a>mse_list33 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-320"><a href="#cb5-320" aria-hidden="true" tabindex="-1"></a>mse_list34 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-321"><a href="#cb5-321" aria-hidden="true" tabindex="-1"></a>mse_list35 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-322"><a href="#cb5-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-323"><a href="#cb5-323" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(stock_file3)){</span>
<span id="cb5-324"><a href="#cb5-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-325"><a href="#cb5-325" aria-hidden="true" tabindex="-1"></a>  count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-326"><a href="#cb5-326" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-327"><a href="#cb5-327" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> stock_file3[[i]]</span>
<span id="cb5-328"><a href="#cb5-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-329"><a href="#cb5-329" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb5-330"><a href="#cb5-330" aria-hidden="true" tabindex="-1"></a>    <span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span> ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span> (bid_size1 <span class="sc">+</span> ask_size1))</span>
<span id="cb5-331"><a href="#cb5-331" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BidAskSpread1 =</span> ask_price1 <span class="sc">/</span> bid_price1 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-332"><a href="#cb5-332" aria-hidden="true" tabindex="-1"></a>  <span class="co">#temporary &lt;- temporary %&gt;% mutate(BidAskSpread2 = ask_price2 / bid_price2 - 1)</span></span>
<span id="cb5-333"><a href="#cb5-333" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">num_order =</span> bid_size1 <span class="sc">+</span> ask_size1 <span class="sc">+</span> bid_size2 <span class="sc">+</span> ask_size2)</span>
<span id="cb5-334"><a href="#cb5-334" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-335"><a href="#cb5-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb5-336"><a href="#cb5-336" aria-hidden="true" tabindex="-1"></a>  log_r1 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-337"><a href="#cb5-337" aria-hidden="true" tabindex="-1"></a>  time_IDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(temporary[, <span class="dv">1</span>])</span>
<span id="cb5-338"><a href="#cb5-338" aria-hidden="true" tabindex="-1"></a>  sample_time_id <span class="ot">=</span> <span class="fu">sample</span>(time_IDs, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-339"><a href="#cb5-339" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-340"><a href="#cb5-340" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(sample_time_id)) {</span>
<span id="cb5-341"><a href="#cb5-341" aria-hidden="true" tabindex="-1"></a>    sec <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(seconds_in_bucket) <span class="co">#对于sample_time_id             中的每个元素，获取 stock1 数据集中 time_id 列等于该元素的行的秒数。</span></span>
<span id="cb5-342"><a href="#cb5-342" aria-hidden="true" tabindex="-1"></a>    BS1 <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(BidAskSpread1)</span>
<span id="cb5-343"><a href="#cb5-343" aria-hidden="true" tabindex="-1"></a>    <span class="co">#BS2 &lt;- temporary %&gt;% filter(time_id == sample_time_id[a]) %&gt;% pull(BidAskSpread2)</span></span>
<span id="cb5-344"><a href="#cb5-344" aria-hidden="true" tabindex="-1"></a>    order <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(num_order)</span>
<span id="cb5-345"><a href="#cb5-345" aria-hidden="true" tabindex="-1"></a>    price <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(WAP) </span>
<span id="cb5-346"><a href="#cb5-346" aria-hidden="true" tabindex="-1"></a>    log_r <span class="ot">&lt;-</span> <span class="fu">log</span>(price[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> price[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(price) <span class="sc">-</span> <span class="dv">1</span>)]) <span class="co">#使用所选行的 WAP 列计算对数收益率</span></span>
<span id="cb5-347"><a href="#cb5-347" aria-hidden="true" tabindex="-1"></a>    log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> sec[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-348"><a href="#cb5-348" aria-hidden="true" tabindex="-1"></a>                              <span class="at">price =</span> price[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-349"><a href="#cb5-349" aria-hidden="true" tabindex="-1"></a>                              <span class="at">BidAskSpread1=</span> BS1[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-350"><a href="#cb5-350" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#BidAskSpread2 = BS2[-1],</span></span>
<span id="cb5-351"><a href="#cb5-351" aria-hidden="true" tabindex="-1"></a>                              <span class="at">num_order =</span> order[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb5-352"><a href="#cb5-352" aria-hidden="true" tabindex="-1"></a>                              <span class="at">log_return =</span> log_r)<span class="co">#将对数收益率存储在一个名为 log_r1 的列表中。</span></span>
<span id="cb5-353"><a href="#cb5-353" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-354"><a href="#cb5-354" aria-hidden="true" tabindex="-1"></a>    time.no.change <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>)[<span class="sc">!</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span> <span class="sc">%in%</span> log_r1[[a]]<span class="sc">$</span>time)]</span>
<span id="cb5-355"><a href="#cb5-355" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(time.no.change) <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co">#如果所选的时间戳没有连续的秒数数据，补充缺失的秒数数据，并将对数收益率设置为 0。</span></span>
<span id="cb5-356"><a href="#cb5-356" aria-hidden="true" tabindex="-1"></a>      new.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time.no.change, </span>
<span id="cb5-357"><a href="#cb5-357" aria-hidden="true" tabindex="-1"></a>                           <span class="at">price =</span> <span class="dv">0</span>, </span>
<span id="cb5-358"><a href="#cb5-358" aria-hidden="true" tabindex="-1"></a>                           <span class="at">BidAskSpread1 =</span> <span class="dv">0</span>, </span>
<span id="cb5-359"><a href="#cb5-359" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#BidAskSpread2 = 0, </span></span>
<span id="cb5-360"><a href="#cb5-360" aria-hidden="true" tabindex="-1"></a>                           <span class="at">num_order =</span> <span class="dv">0</span>, </span>
<span id="cb5-361"><a href="#cb5-361" aria-hidden="true" tabindex="-1"></a>                           <span class="at">log_return =</span> <span class="dv">0</span>)</span>
<span id="cb5-362"><a href="#cb5-362" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(log_r1[[a]], new.df)</span>
<span id="cb5-363"><a href="#cb5-363" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> log_r1[[a]][<span class="fu">order</span>(log_r1[[a]]<span class="sc">$</span>time), ]</span>
<span id="cb5-364"><a href="#cb5-364" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-365"><a href="#cb5-365" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-366"><a href="#cb5-366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-367"><a href="#cb5-367" aria-hidden="true" tabindex="-1"></a>  vol <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-368"><a href="#cb5-368" aria-hidden="true" tabindex="-1"></a>  comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-369"><a href="#cb5-369" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb5-370"><a href="#cb5-370" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-371"><a href="#cb5-371" aria-hidden="true" tabindex="-1"></a>  comp_price <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-372"><a href="#cb5-372" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>((<span class="fu">sum</span>(x))<span class="sc">/</span><span class="fu">length</span>(x))</span>
<span id="cb5-373"><a href="#cb5-373" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-374"><a href="#cb5-374" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb5-375"><a href="#cb5-375" aria-hidden="true" tabindex="-1"></a>    log_r1[[b]] <span class="ot">&lt;-</span> log_r1[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time_bucket =</span> <span class="fu">ceiling</span>(time <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb5-376"><a href="#cb5-376" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_vol)</span>
<span id="cb5-377"><a href="#cb5-377" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(price <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-378"><a href="#cb5-378" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(BidAskSpread1 <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-379"><a href="#cb5-379" aria-hidden="true" tabindex="-1"></a>    <span class="co">#vol[[b]] &lt;- vol[[b]] %&gt;% mutate(aggregate(BidAskSpread2 ~ time_bucket, data = log_r1[[b]], FUN = comp_price))</span></span>
<span id="cb5-380"><a href="#cb5-380" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(num_order <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-381"><a href="#cb5-381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(vol[[b]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, </span>
<span id="cb5-382"><a href="#cb5-382" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'volatility'</span>,</span>
<span id="cb5-383"><a href="#cb5-383" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'price'</span>, </span>
<span id="cb5-384"><a href="#cb5-384" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'BidAskSpread1'</span>, </span>
<span id="cb5-385"><a href="#cb5-385" aria-hidden="true" tabindex="-1"></a>                            <span class="co">#'BidAskSpread2', </span></span>
<span id="cb5-386"><a href="#cb5-386" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'num_order'</span> )</span>
<span id="cb5-387"><a href="#cb5-387" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-388"><a href="#cb5-388" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-389"><a href="#cb5-389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-390"><a href="#cb5-390" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(vol)){</span>
<span id="cb5-391"><a href="#cb5-391" aria-hidden="true" tabindex="-1"></a>    inTrain <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(<span class="at">y=</span>vol[[e]]<span class="sc">$</span>volatility,<span class="at">p=</span><span class="fl">0.8</span>,<span class="at">list=</span><span class="cn">FALSE</span>)</span>
<span id="cb5-392"><a href="#cb5-392" aria-hidden="true" tabindex="-1"></a>    training <span class="ot">&lt;-</span> vol[[e]][inTrain, ]</span>
<span id="cb5-393"><a href="#cb5-393" aria-hidden="true" tabindex="-1"></a>    testing <span class="ot">&lt;-</span> vol[[e]][<span class="sc">-</span>inTrain, ]</span>
<span id="cb5-394"><a href="#cb5-394" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-395"><a href="#cb5-395" aria-hidden="true" tabindex="-1"></a>    glmnet3 <span class="ot">&lt;-</span> <span class="fu">train</span>(volatility <span class="sc">~</span> ., <span class="at">data =</span> training, <span class="at">method =</span> <span class="st">"glmnet"</span>,</span>
<span id="cb5-396"><a href="#cb5-396" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>),</span>
<span id="cb5-397"><a href="#cb5-397" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">1e-8</span>, <span class="fl">1e-1</span>, <span class="at">length =</span> <span class="dv">300</span>)))</span>
<span id="cb5-398"><a href="#cb5-398" aria-hidden="true" tabindex="-1"></a>                   <span class="co">#tuneGrid = expand.grid(alpha = 0, lambda = seq(1e-10, 1e-3, length = 300))) #seq(0.00000001, 10, length = 300)))</span></span>
<span id="cb5-399"><a href="#cb5-399" aria-hidden="true" tabindex="-1"></a>    predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet3, <span class="at">newdata =</span> testing)</span>
<span id="cb5-400"><a href="#cb5-400" aria-hidden="true" tabindex="-1"></a>    mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((predicted <span class="sc">-</span> testing<span class="sc">$</span>volatility)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb5-401"><a href="#cb5-401" aria-hidden="true" tabindex="-1"></a>    total_mse3 <span class="ot">&lt;-</span> <span class="fu">c</span>(total_mse3, mse)</span>
<span id="cb5-402"><a href="#cb5-402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb5-403"><a href="#cb5-403" aria-hidden="true" tabindex="-1"></a>      mse_list31 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list31, mse)</span>
<span id="cb5-404"><a href="#cb5-404" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-405"><a href="#cb5-405" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb5-406"><a href="#cb5-406" aria-hidden="true" tabindex="-1"></a>      mse_list32 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list32, mse)</span>
<span id="cb5-407"><a href="#cb5-407" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-408"><a href="#cb5-408" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb5-409"><a href="#cb5-409" aria-hidden="true" tabindex="-1"></a>      mse_list33 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list33, mse)</span>
<span id="cb5-410"><a href="#cb5-410" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-411"><a href="#cb5-411" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">4</span>){</span>
<span id="cb5-412"><a href="#cb5-412" aria-hidden="true" tabindex="-1"></a>      mse_list34 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list34, mse)</span>
<span id="cb5-413"><a href="#cb5-413" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-414"><a href="#cb5-414" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">5</span>){</span>
<span id="cb5-415"><a href="#cb5-415" aria-hidden="true" tabindex="-1"></a>      mse_list35 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list35, mse)</span>
<span id="cb5-416"><a href="#cb5-416" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-417"><a href="#cb5-417" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-418"><a href="#cb5-418" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-419"><a href="#cb5-419" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(total_mse3), <span class="fu">sqrt</span>(<span class="fu">mean</span>(total_mse3)))</span>
<span id="cb5-420"><a href="#cb5-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-421"><a href="#cb5-421" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(total_mse3,<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-422"><a href="#cb5-422" aria-hidden="true" tabindex="-1"></a>count <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-423"><a href="#cb5-423" aria-hidden="true" tabindex="-1"></a>total_mse4 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-424"><a href="#cb5-424" aria-hidden="true" tabindex="-1"></a>mse_list41 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-425"><a href="#cb5-425" aria-hidden="true" tabindex="-1"></a>mse_list42 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-426"><a href="#cb5-426" aria-hidden="true" tabindex="-1"></a>mse_list43 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-427"><a href="#cb5-427" aria-hidden="true" tabindex="-1"></a>mse_list44 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-428"><a href="#cb5-428" aria-hidden="true" tabindex="-1"></a>mse_list45 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-429"><a href="#cb5-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-430"><a href="#cb5-430" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(stock_file4)){</span>
<span id="cb5-431"><a href="#cb5-431" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-432"><a href="#cb5-432" aria-hidden="true" tabindex="-1"></a>  count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-433"><a href="#cb5-433" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-434"><a href="#cb5-434" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> stock_file4[[i]]</span>
<span id="cb5-435"><a href="#cb5-435" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-436"><a href="#cb5-436" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb5-437"><a href="#cb5-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span> ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span> (bid_size1 <span class="sc">+</span> ask_size1))</span>
<span id="cb5-438"><a href="#cb5-438" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BidAskSpread1 =</span> ask_price1 <span class="sc">/</span> bid_price1 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-439"><a href="#cb5-439" aria-hidden="true" tabindex="-1"></a>  <span class="co">#temporary &lt;- temporary %&gt;% mutate(BidAskSpread2 = ask_price2 / bid_price2 - 1)</span></span>
<span id="cb5-440"><a href="#cb5-440" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">num_order =</span> bid_size1 <span class="sc">+</span> ask_size1 <span class="sc">+</span> bid_size2 <span class="sc">+</span> ask_size2)</span>
<span id="cb5-441"><a href="#cb5-441" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-442"><a href="#cb5-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb5-443"><a href="#cb5-443" aria-hidden="true" tabindex="-1"></a>  log_r1 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-444"><a href="#cb5-444" aria-hidden="true" tabindex="-1"></a>  time_IDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(temporary[, <span class="dv">1</span>])</span>
<span id="cb5-445"><a href="#cb5-445" aria-hidden="true" tabindex="-1"></a>  sample_time_id <span class="ot">=</span> <span class="fu">sample</span>(time_IDs, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-446"><a href="#cb5-446" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-447"><a href="#cb5-447" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(sample_time_id)) {</span>
<span id="cb5-448"><a href="#cb5-448" aria-hidden="true" tabindex="-1"></a>    sec <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(seconds_in_bucket) <span class="co">#对于sample_time_id             中的每个元素，获取 stock1 数据集中 time_id 列等于该元素的行的秒数。</span></span>
<span id="cb5-449"><a href="#cb5-449" aria-hidden="true" tabindex="-1"></a>    BS1 <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(BidAskSpread1)</span>
<span id="cb5-450"><a href="#cb5-450" aria-hidden="true" tabindex="-1"></a>    <span class="co">#BS2 &lt;- temporary %&gt;% filter(time_id == sample_time_id[a]) %&gt;% pull(BidAskSpread2)</span></span>
<span id="cb5-451"><a href="#cb5-451" aria-hidden="true" tabindex="-1"></a>    order <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(num_order)</span>
<span id="cb5-452"><a href="#cb5-452" aria-hidden="true" tabindex="-1"></a>    price <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(WAP) </span>
<span id="cb5-453"><a href="#cb5-453" aria-hidden="true" tabindex="-1"></a>    log_r <span class="ot">&lt;-</span> <span class="fu">log</span>(price[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> price[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(price) <span class="sc">-</span> <span class="dv">1</span>)]) <span class="co">#使用所选行的 WAP 列计算对数收益率</span></span>
<span id="cb5-454"><a href="#cb5-454" aria-hidden="true" tabindex="-1"></a>    log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> sec[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-455"><a href="#cb5-455" aria-hidden="true" tabindex="-1"></a>                              <span class="at">price =</span> price[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-456"><a href="#cb5-456" aria-hidden="true" tabindex="-1"></a>                              <span class="at">BidAskSpread1=</span> BS1[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-457"><a href="#cb5-457" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#BidAskSpread2 = BS2[-1],</span></span>
<span id="cb5-458"><a href="#cb5-458" aria-hidden="true" tabindex="-1"></a>                              <span class="at">num_order =</span> order[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb5-459"><a href="#cb5-459" aria-hidden="true" tabindex="-1"></a>                              <span class="at">log_return =</span> log_r)<span class="co">#将对数收益率存储在一个名为 log_r1 的列表中。</span></span>
<span id="cb5-460"><a href="#cb5-460" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-461"><a href="#cb5-461" aria-hidden="true" tabindex="-1"></a>    time.no.change <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>)[<span class="sc">!</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span> <span class="sc">%in%</span> log_r1[[a]]<span class="sc">$</span>time)]</span>
<span id="cb5-462"><a href="#cb5-462" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(time.no.change) <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co">#如果所选的时间戳没有连续的秒数数据，补充缺失的秒数数据，并将对数收益率设置为 0。</span></span>
<span id="cb5-463"><a href="#cb5-463" aria-hidden="true" tabindex="-1"></a>      new.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time.no.change, </span>
<span id="cb5-464"><a href="#cb5-464" aria-hidden="true" tabindex="-1"></a>                           <span class="at">price =</span> <span class="dv">0</span>, </span>
<span id="cb5-465"><a href="#cb5-465" aria-hidden="true" tabindex="-1"></a>                           <span class="at">BidAskSpread1 =</span> <span class="dv">0</span>, </span>
<span id="cb5-466"><a href="#cb5-466" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#BidAskSpread2 = 0, </span></span>
<span id="cb5-467"><a href="#cb5-467" aria-hidden="true" tabindex="-1"></a>                           <span class="at">num_order =</span> <span class="dv">0</span>, </span>
<span id="cb5-468"><a href="#cb5-468" aria-hidden="true" tabindex="-1"></a>                           <span class="at">log_return =</span> <span class="dv">0</span>)</span>
<span id="cb5-469"><a href="#cb5-469" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(log_r1[[a]], new.df)</span>
<span id="cb5-470"><a href="#cb5-470" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> log_r1[[a]][<span class="fu">order</span>(log_r1[[a]]<span class="sc">$</span>time), ]</span>
<span id="cb5-471"><a href="#cb5-471" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-472"><a href="#cb5-472" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-473"><a href="#cb5-473" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-474"><a href="#cb5-474" aria-hidden="true" tabindex="-1"></a>  vol <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-475"><a href="#cb5-475" aria-hidden="true" tabindex="-1"></a>  comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-476"><a href="#cb5-476" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb5-477"><a href="#cb5-477" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-478"><a href="#cb5-478" aria-hidden="true" tabindex="-1"></a>  comp_price <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-479"><a href="#cb5-479" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>((<span class="fu">sum</span>(x))<span class="sc">/</span><span class="fu">length</span>(x))</span>
<span id="cb5-480"><a href="#cb5-480" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-481"><a href="#cb5-481" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb5-482"><a href="#cb5-482" aria-hidden="true" tabindex="-1"></a>    log_r1[[b]] <span class="ot">&lt;-</span> log_r1[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time_bucket =</span> <span class="fu">ceiling</span>(time <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb5-483"><a href="#cb5-483" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_vol)</span>
<span id="cb5-484"><a href="#cb5-484" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(price <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-485"><a href="#cb5-485" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(BidAskSpread1 <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-486"><a href="#cb5-486" aria-hidden="true" tabindex="-1"></a>    <span class="co">#vol[[b]] &lt;- vol[[b]] %&gt;% mutate(aggregate(BidAskSpread2 ~ time_bucket, data = log_r1[[b]], FUN = comp_price))</span></span>
<span id="cb5-487"><a href="#cb5-487" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(num_order <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-488"><a href="#cb5-488" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(vol[[b]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, </span>
<span id="cb5-489"><a href="#cb5-489" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'volatility'</span>,</span>
<span id="cb5-490"><a href="#cb5-490" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'price'</span>, </span>
<span id="cb5-491"><a href="#cb5-491" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'BidAskSpread1'</span>, </span>
<span id="cb5-492"><a href="#cb5-492" aria-hidden="true" tabindex="-1"></a>                            <span class="co">#'BidAskSpread2', </span></span>
<span id="cb5-493"><a href="#cb5-493" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'num_order'</span> )</span>
<span id="cb5-494"><a href="#cb5-494" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-495"><a href="#cb5-495" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-496"><a href="#cb5-496" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-497"><a href="#cb5-497" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(vol)){</span>
<span id="cb5-498"><a href="#cb5-498" aria-hidden="true" tabindex="-1"></a>    inTrain <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(<span class="at">y=</span>vol[[e]]<span class="sc">$</span>volatility,<span class="at">p=</span><span class="fl">0.8</span>,<span class="at">list=</span><span class="cn">FALSE</span>)</span>
<span id="cb5-499"><a href="#cb5-499" aria-hidden="true" tabindex="-1"></a>    training <span class="ot">&lt;-</span> vol[[e]][inTrain, ]</span>
<span id="cb5-500"><a href="#cb5-500" aria-hidden="true" tabindex="-1"></a>    training <span class="ot">&lt;-</span> training[, <span class="sc">!</span><span class="fu">colnames</span>(training) <span class="sc">%in%</span> <span class="st">"time_bucket"</span>]</span>
<span id="cb5-501"><a href="#cb5-501" aria-hidden="true" tabindex="-1"></a>    testing <span class="ot">&lt;-</span> vol[[e]][<span class="sc">-</span>inTrain, ]</span>
<span id="cb5-502"><a href="#cb5-502" aria-hidden="true" tabindex="-1"></a>    testing <span class="ot">&lt;-</span> testing[, <span class="sc">!</span><span class="fu">colnames</span>(testing) <span class="sc">%in%</span> <span class="st">"time_bucket"</span>]</span>
<span id="cb5-503"><a href="#cb5-503" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-504"><a href="#cb5-504" aria-hidden="true" tabindex="-1"></a>    glmnet4 <span class="ot">&lt;-</span> <span class="fu">train</span>(volatility <span class="sc">~</span> ., <span class="at">data =</span> training, <span class="at">method =</span> <span class="st">"glmnet"</span>,</span>
<span id="cb5-505"><a href="#cb5-505" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>),</span>
<span id="cb5-506"><a href="#cb5-506" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fl">7.61524e-05</span>)) <span class="co">#seq(1e-10, 1e-3, length = 300) 7.61524e-05</span></span>
<span id="cb5-507"><a href="#cb5-507" aria-hidden="true" tabindex="-1"></a>    predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet4, <span class="at">newdata =</span> testing)</span>
<span id="cb5-508"><a href="#cb5-508" aria-hidden="true" tabindex="-1"></a>    mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((predicted <span class="sc">-</span> testing<span class="sc">$</span>volatility)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb5-509"><a href="#cb5-509" aria-hidden="true" tabindex="-1"></a>    total_mse4 <span class="ot">&lt;-</span> <span class="fu">c</span>(total_mse4, mse)</span>
<span id="cb5-510"><a href="#cb5-510" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb5-511"><a href="#cb5-511" aria-hidden="true" tabindex="-1"></a>      mse_list41 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list41, mse)</span>
<span id="cb5-512"><a href="#cb5-512" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-513"><a href="#cb5-513" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb5-514"><a href="#cb5-514" aria-hidden="true" tabindex="-1"></a>      mse_list42 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list42, mse)</span>
<span id="cb5-515"><a href="#cb5-515" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-516"><a href="#cb5-516" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb5-517"><a href="#cb5-517" aria-hidden="true" tabindex="-1"></a>      mse_list43 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list43, mse)</span>
<span id="cb5-518"><a href="#cb5-518" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-519"><a href="#cb5-519" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">4</span>){</span>
<span id="cb5-520"><a href="#cb5-520" aria-hidden="true" tabindex="-1"></a>      mse_list44 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list44, mse)</span>
<span id="cb5-521"><a href="#cb5-521" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-522"><a href="#cb5-522" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">5</span>){</span>
<span id="cb5-523"><a href="#cb5-523" aria-hidden="true" tabindex="-1"></a>      mse_list45 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list45, mse)</span>
<span id="cb5-524"><a href="#cb5-524" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-525"><a href="#cb5-525" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-526"><a href="#cb5-526" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-527"><a href="#cb5-527" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(total_mse4), <span class="fu">sqrt</span>(<span class="fu">mean</span>(total_mse4)))</span>
<span id="cb5-528"><a href="#cb5-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-529"><a href="#cb5-529" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(total_mse4,<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-530"><a href="#cb5-530" aria-hidden="true" tabindex="-1"></a>count <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-531"><a href="#cb5-531" aria-hidden="true" tabindex="-1"></a>total_mse5 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-532"><a href="#cb5-532" aria-hidden="true" tabindex="-1"></a>mse_list51 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-533"><a href="#cb5-533" aria-hidden="true" tabindex="-1"></a>mse_list52 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-534"><a href="#cb5-534" aria-hidden="true" tabindex="-1"></a>mse_list53 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-535"><a href="#cb5-535" aria-hidden="true" tabindex="-1"></a>mse_list54 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-536"><a href="#cb5-536" aria-hidden="true" tabindex="-1"></a>mse_list55 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-537"><a href="#cb5-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-538"><a href="#cb5-538" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(stock_file5)){</span>
<span id="cb5-539"><a href="#cb5-539" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-540"><a href="#cb5-540" aria-hidden="true" tabindex="-1"></a>  count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-541"><a href="#cb5-541" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-542"><a href="#cb5-542" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> stock_file5[[i]]</span>
<span id="cb5-543"><a href="#cb5-543" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-544"><a href="#cb5-544" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb5-545"><a href="#cb5-545" aria-hidden="true" tabindex="-1"></a>    <span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span> ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span> (bid_size1 <span class="sc">+</span> ask_size1))</span>
<span id="cb5-546"><a href="#cb5-546" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BidAskSpread1 =</span> ask_price1 <span class="sc">/</span> bid_price1 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-547"><a href="#cb5-547" aria-hidden="true" tabindex="-1"></a>  <span class="co">#temporary &lt;- temporary %&gt;% mutate(BidAskSpread2 = ask_price2 / bid_price2 - 1)</span></span>
<span id="cb5-548"><a href="#cb5-548" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">num_order =</span> bid_size1 <span class="sc">+</span> ask_size1 <span class="sc">+</span> bid_size2 <span class="sc">+</span> ask_size2)</span>
<span id="cb5-549"><a href="#cb5-549" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-550"><a href="#cb5-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">5</span>)</span>
<span id="cb5-551"><a href="#cb5-551" aria-hidden="true" tabindex="-1"></a>  log_r1 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-552"><a href="#cb5-552" aria-hidden="true" tabindex="-1"></a>  time_IDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(temporary[, <span class="dv">1</span>])</span>
<span id="cb5-553"><a href="#cb5-553" aria-hidden="true" tabindex="-1"></a>  sample_time_id <span class="ot">=</span> <span class="fu">sample</span>(time_IDs, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-554"><a href="#cb5-554" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-555"><a href="#cb5-555" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(sample_time_id)) {</span>
<span id="cb5-556"><a href="#cb5-556" aria-hidden="true" tabindex="-1"></a>    sec <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(seconds_in_bucket) <span class="co">#对于sample_time_id             中的每个元素，获取 stock1 数据集中 time_id 列等于该元素的行的秒数。</span></span>
<span id="cb5-557"><a href="#cb5-557" aria-hidden="true" tabindex="-1"></a>    BS1 <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(BidAskSpread1)</span>
<span id="cb5-558"><a href="#cb5-558" aria-hidden="true" tabindex="-1"></a>    <span class="co">#BS2 &lt;- temporary %&gt;% filter(time_id == sample_time_id[a]) %&gt;% pull(BidAskSpread2)</span></span>
<span id="cb5-559"><a href="#cb5-559" aria-hidden="true" tabindex="-1"></a>    order <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(num_order)</span>
<span id="cb5-560"><a href="#cb5-560" aria-hidden="true" tabindex="-1"></a>    price <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(WAP) </span>
<span id="cb5-561"><a href="#cb5-561" aria-hidden="true" tabindex="-1"></a>    log_r <span class="ot">&lt;-</span> <span class="fu">log</span>(price[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> price[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(price) <span class="sc">-</span> <span class="dv">1</span>)]) <span class="co">#使用所选行的 WAP 列计算对数收益率</span></span>
<span id="cb5-562"><a href="#cb5-562" aria-hidden="true" tabindex="-1"></a>    log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> sec[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-563"><a href="#cb5-563" aria-hidden="true" tabindex="-1"></a>                              <span class="at">price =</span> price[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-564"><a href="#cb5-564" aria-hidden="true" tabindex="-1"></a>                              <span class="at">BidAskSpread1=</span> BS1[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-565"><a href="#cb5-565" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#BidAskSpread2 = BS2[-1],</span></span>
<span id="cb5-566"><a href="#cb5-566" aria-hidden="true" tabindex="-1"></a>                              <span class="at">num_order =</span> order[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb5-567"><a href="#cb5-567" aria-hidden="true" tabindex="-1"></a>                              <span class="at">log_return =</span> log_r)<span class="co">#将对数收益率存储在一个名为 log_r1 的列表中。</span></span>
<span id="cb5-568"><a href="#cb5-568" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-569"><a href="#cb5-569" aria-hidden="true" tabindex="-1"></a>    time.no.change <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>)[<span class="sc">!</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span> <span class="sc">%in%</span> log_r1[[a]]<span class="sc">$</span>time)]</span>
<span id="cb5-570"><a href="#cb5-570" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(time.no.change) <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co">#如果所选的时间戳没有连续的秒数数据，补充缺失的秒数数据，并将对数收益率设置为 0。</span></span>
<span id="cb5-571"><a href="#cb5-571" aria-hidden="true" tabindex="-1"></a>      new.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time.no.change, </span>
<span id="cb5-572"><a href="#cb5-572" aria-hidden="true" tabindex="-1"></a>                           <span class="at">price =</span> <span class="dv">0</span>, </span>
<span id="cb5-573"><a href="#cb5-573" aria-hidden="true" tabindex="-1"></a>                           <span class="at">BidAskSpread1 =</span> <span class="dv">0</span>, </span>
<span id="cb5-574"><a href="#cb5-574" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#BidAskSpread2 = 0, </span></span>
<span id="cb5-575"><a href="#cb5-575" aria-hidden="true" tabindex="-1"></a>                           <span class="at">num_order =</span> <span class="dv">0</span>, </span>
<span id="cb5-576"><a href="#cb5-576" aria-hidden="true" tabindex="-1"></a>                           <span class="at">log_return =</span> <span class="dv">0</span>)</span>
<span id="cb5-577"><a href="#cb5-577" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(log_r1[[a]], new.df)</span>
<span id="cb5-578"><a href="#cb5-578" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> log_r1[[a]][<span class="fu">order</span>(log_r1[[a]]<span class="sc">$</span>time), ]</span>
<span id="cb5-579"><a href="#cb5-579" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-580"><a href="#cb5-580" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-581"><a href="#cb5-581" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-582"><a href="#cb5-582" aria-hidden="true" tabindex="-1"></a>  vol <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-583"><a href="#cb5-583" aria-hidden="true" tabindex="-1"></a>  comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-584"><a href="#cb5-584" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb5-585"><a href="#cb5-585" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-586"><a href="#cb5-586" aria-hidden="true" tabindex="-1"></a>  comp_price <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-587"><a href="#cb5-587" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>((<span class="fu">sum</span>(x))<span class="sc">/</span><span class="fu">length</span>(x))</span>
<span id="cb5-588"><a href="#cb5-588" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-589"><a href="#cb5-589" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb5-590"><a href="#cb5-590" aria-hidden="true" tabindex="-1"></a>    log_r1[[b]] <span class="ot">&lt;-</span> log_r1[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time_bucket =</span> <span class="fu">ceiling</span>(time <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb5-591"><a href="#cb5-591" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_vol)</span>
<span id="cb5-592"><a href="#cb5-592" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(price <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-593"><a href="#cb5-593" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(BidAskSpread1 <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-594"><a href="#cb5-594" aria-hidden="true" tabindex="-1"></a>    <span class="co">#vol[[b]] &lt;- vol[[b]] %&gt;% mutate(aggregate(BidAskSpread2 ~ time_bucket, data = log_r1[[b]], FUN = comp_price))</span></span>
<span id="cb5-595"><a href="#cb5-595" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(num_order <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-596"><a href="#cb5-596" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(vol[[b]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, </span>
<span id="cb5-597"><a href="#cb5-597" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'volatility'</span>,</span>
<span id="cb5-598"><a href="#cb5-598" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'price'</span>, </span>
<span id="cb5-599"><a href="#cb5-599" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'BidAskSpread1'</span>, </span>
<span id="cb5-600"><a href="#cb5-600" aria-hidden="true" tabindex="-1"></a>                            <span class="co">#'BidAskSpread2', </span></span>
<span id="cb5-601"><a href="#cb5-601" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'num_order'</span> )</span>
<span id="cb5-602"><a href="#cb5-602" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-603"><a href="#cb5-603" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-604"><a href="#cb5-604" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-605"><a href="#cb5-605" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(vol)){</span>
<span id="cb5-606"><a href="#cb5-606" aria-hidden="true" tabindex="-1"></a>    inTrain <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(<span class="at">y=</span>vol[[e]]<span class="sc">$</span>volatility,<span class="at">p=</span><span class="fl">0.8</span>,<span class="at">list=</span><span class="cn">FALSE</span>)</span>
<span id="cb5-607"><a href="#cb5-607" aria-hidden="true" tabindex="-1"></a>    training <span class="ot">&lt;-</span> vol[[e]][inTrain, ]</span>
<span id="cb5-608"><a href="#cb5-608" aria-hidden="true" tabindex="-1"></a>    testing <span class="ot">&lt;-</span> vol[[e]][<span class="sc">-</span>inTrain, ]</span>
<span id="cb5-609"><a href="#cb5-609" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-610"><a href="#cb5-610" aria-hidden="true" tabindex="-1"></a>    glmnet5 <span class="ot">&lt;-</span> <span class="fu">train</span>(volatility <span class="sc">~</span> ., <span class="at">data =</span> training, <span class="at">method =</span> <span class="st">"glmnet"</span>,</span>
<span id="cb5-611"><a href="#cb5-611" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>),</span>
<span id="cb5-612"><a href="#cb5-612" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">1e-8</span>, <span class="fl">1e-1</span>, <span class="at">length =</span> <span class="dv">300</span>)))</span>
<span id="cb5-613"><a href="#cb5-613" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb5-614"><a href="#cb5-614" aria-hidden="true" tabindex="-1"></a>    predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet5, <span class="at">newdata =</span> testing)</span>
<span id="cb5-615"><a href="#cb5-615" aria-hidden="true" tabindex="-1"></a>    mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((predicted <span class="sc">-</span> testing<span class="sc">$</span>volatility)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb5-616"><a href="#cb5-616" aria-hidden="true" tabindex="-1"></a>    total_mse5 <span class="ot">&lt;-</span> <span class="fu">c</span>(total_mse5, mse)</span>
<span id="cb5-617"><a href="#cb5-617" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb5-618"><a href="#cb5-618" aria-hidden="true" tabindex="-1"></a>      mse_list51 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list51, mse)</span>
<span id="cb5-619"><a href="#cb5-619" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-620"><a href="#cb5-620" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb5-621"><a href="#cb5-621" aria-hidden="true" tabindex="-1"></a>      mse_list52 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list52, mse)</span>
<span id="cb5-622"><a href="#cb5-622" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-623"><a href="#cb5-623" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb5-624"><a href="#cb5-624" aria-hidden="true" tabindex="-1"></a>      mse_list53 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list53, mse)</span>
<span id="cb5-625"><a href="#cb5-625" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-626"><a href="#cb5-626" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">4</span>){</span>
<span id="cb5-627"><a href="#cb5-627" aria-hidden="true" tabindex="-1"></a>      mse_list54 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list54, mse)</span>
<span id="cb5-628"><a href="#cb5-628" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-629"><a href="#cb5-629" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">5</span>){</span>
<span id="cb5-630"><a href="#cb5-630" aria-hidden="true" tabindex="-1"></a>      mse_list55 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list55, mse)</span>
<span id="cb5-631"><a href="#cb5-631" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-632"><a href="#cb5-632" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-633"><a href="#cb5-633" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-634"><a href="#cb5-634" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(total_mse5), <span class="fu">sqrt</span>(<span class="fu">mean</span>(total_mse5)))</span>
<span id="cb5-635"><a href="#cb5-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-636"><a href="#cb5-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-637"><a href="#cb5-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-638"><a href="#cb5-638" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(total_mse5,<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-639"><a href="#cb5-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-640"><a href="#cb5-640" aria-hidden="true" tabindex="-1"></a>count <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-641"><a href="#cb5-641" aria-hidden="true" tabindex="-1"></a>total_mse6 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-642"><a href="#cb5-642" aria-hidden="true" tabindex="-1"></a>total_qlk6 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-643"><a href="#cb5-643" aria-hidden="true" tabindex="-1"></a>mse_list61 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-644"><a href="#cb5-644" aria-hidden="true" tabindex="-1"></a>mse_list62 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-645"><a href="#cb5-645" aria-hidden="true" tabindex="-1"></a>mse_list63 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-646"><a href="#cb5-646" aria-hidden="true" tabindex="-1"></a>mse_list64 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-647"><a href="#cb5-647" aria-hidden="true" tabindex="-1"></a>mse_list65 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb5-648"><a href="#cb5-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-649"><a href="#cb5-649" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(stock_file6)){</span>
<span id="cb5-650"><a href="#cb5-650" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-651"><a href="#cb5-651" aria-hidden="true" tabindex="-1"></a>  count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-652"><a href="#cb5-652" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-653"><a href="#cb5-653" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> stock_file6[[i]]</span>
<span id="cb5-654"><a href="#cb5-654" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-655"><a href="#cb5-655" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb5-656"><a href="#cb5-656" aria-hidden="true" tabindex="-1"></a>    <span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span> ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span> (bid_size1 <span class="sc">+</span> ask_size1))</span>
<span id="cb5-657"><a href="#cb5-657" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BidAskSpread1 =</span> ask_price1 <span class="sc">/</span> bid_price1 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-658"><a href="#cb5-658" aria-hidden="true" tabindex="-1"></a>  <span class="co">#temporary &lt;- temporary %&gt;% mutate(BidAskSpread2 = ask_price2 / bid_price2 - 1)</span></span>
<span id="cb5-659"><a href="#cb5-659" aria-hidden="true" tabindex="-1"></a>  temporary <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">num_order =</span> bid_size1 <span class="sc">+</span> ask_size1 <span class="sc">+</span> bid_size2 <span class="sc">+</span> ask_size2)</span>
<span id="cb5-660"><a href="#cb5-660" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-661"><a href="#cb5-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">6</span>)</span>
<span id="cb5-662"><a href="#cb5-662" aria-hidden="true" tabindex="-1"></a>  log_r1 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-663"><a href="#cb5-663" aria-hidden="true" tabindex="-1"></a>  time_IDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(temporary[, <span class="dv">1</span>])</span>
<span id="cb5-664"><a href="#cb5-664" aria-hidden="true" tabindex="-1"></a>  sample_time_id <span class="ot">=</span> <span class="fu">sample</span>(time_IDs, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-665"><a href="#cb5-665" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-666"><a href="#cb5-666" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(sample_time_id)) {</span>
<span id="cb5-667"><a href="#cb5-667" aria-hidden="true" tabindex="-1"></a>    sec <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(seconds_in_bucket) <span class="co">#对于sample_time_id             中的每个元素，获取 stock1 数据集中 time_id 列等于该元素的行的秒数。</span></span>
<span id="cb5-668"><a href="#cb5-668" aria-hidden="true" tabindex="-1"></a>    BS1 <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(BidAskSpread1)</span>
<span id="cb5-669"><a href="#cb5-669" aria-hidden="true" tabindex="-1"></a>    <span class="co">#BS2 &lt;- temporary %&gt;% filter(time_id == sample_time_id[a]) %&gt;% pull(BidAskSpread2)</span></span>
<span id="cb5-670"><a href="#cb5-670" aria-hidden="true" tabindex="-1"></a>    order <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(num_order)</span>
<span id="cb5-671"><a href="#cb5-671" aria-hidden="true" tabindex="-1"></a>    price <span class="ot">&lt;-</span> temporary <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> sample_time_id[a]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(WAP) </span>
<span id="cb5-672"><a href="#cb5-672" aria-hidden="true" tabindex="-1"></a>    log_r <span class="ot">&lt;-</span> <span class="fu">log</span>(price[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> price[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(price) <span class="sc">-</span> <span class="dv">1</span>)]) <span class="co">#使用所选行的 WAP 列计算对数收益率</span></span>
<span id="cb5-673"><a href="#cb5-673" aria-hidden="true" tabindex="-1"></a>    log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> sec[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-674"><a href="#cb5-674" aria-hidden="true" tabindex="-1"></a>                              <span class="at">price =</span> price[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-675"><a href="#cb5-675" aria-hidden="true" tabindex="-1"></a>                              <span class="at">BidAskSpread1=</span> BS1[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb5-676"><a href="#cb5-676" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#BidAskSpread2 = BS2[-1],</span></span>
<span id="cb5-677"><a href="#cb5-677" aria-hidden="true" tabindex="-1"></a>                              <span class="at">num_order =</span> order[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb5-678"><a href="#cb5-678" aria-hidden="true" tabindex="-1"></a>                              <span class="at">log_return =</span> log_r)<span class="co">#将对数收益率存储在一个名为 log_r1 的列表中。</span></span>
<span id="cb5-679"><a href="#cb5-679" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-680"><a href="#cb5-680" aria-hidden="true" tabindex="-1"></a>    time.no.change <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>)[<span class="sc">!</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span> <span class="sc">%in%</span> log_r1[[a]]<span class="sc">$</span>time)]</span>
<span id="cb5-681"><a href="#cb5-681" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(time.no.change) <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co">#如果所选的时间戳没有连续的秒数数据，补充缺失的秒数数据，并将对数收益率设置为 0。</span></span>
<span id="cb5-682"><a href="#cb5-682" aria-hidden="true" tabindex="-1"></a>      new.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time.no.change, </span>
<span id="cb5-683"><a href="#cb5-683" aria-hidden="true" tabindex="-1"></a>                           <span class="at">price =</span> <span class="dv">0</span>, </span>
<span id="cb5-684"><a href="#cb5-684" aria-hidden="true" tabindex="-1"></a>                           <span class="at">BidAskSpread1 =</span> <span class="dv">0</span>, </span>
<span id="cb5-685"><a href="#cb5-685" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#BidAskSpread2 = 0, </span></span>
<span id="cb5-686"><a href="#cb5-686" aria-hidden="true" tabindex="-1"></a>                           <span class="at">num_order =</span> <span class="dv">0</span>, </span>
<span id="cb5-687"><a href="#cb5-687" aria-hidden="true" tabindex="-1"></a>                           <span class="at">log_return =</span> <span class="dv">0</span>)</span>
<span id="cb5-688"><a href="#cb5-688" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(log_r1[[a]], new.df)</span>
<span id="cb5-689"><a href="#cb5-689" aria-hidden="true" tabindex="-1"></a>      log_r1[[a]] <span class="ot">&lt;-</span> log_r1[[a]][<span class="fu">order</span>(log_r1[[a]]<span class="sc">$</span>time), ]</span>
<span id="cb5-690"><a href="#cb5-690" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-691"><a href="#cb5-691" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-692"><a href="#cb5-692" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-693"><a href="#cb5-693" aria-hidden="true" tabindex="-1"></a>  vol <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-694"><a href="#cb5-694" aria-hidden="true" tabindex="-1"></a>  comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-695"><a href="#cb5-695" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb5-696"><a href="#cb5-696" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-697"><a href="#cb5-697" aria-hidden="true" tabindex="-1"></a>  comp_price <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb5-698"><a href="#cb5-698" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>((<span class="fu">sum</span>(x))<span class="sc">/</span><span class="fu">length</span>(x))</span>
<span id="cb5-699"><a href="#cb5-699" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-700"><a href="#cb5-700" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb5-701"><a href="#cb5-701" aria-hidden="true" tabindex="-1"></a>    log_r1[[b]] <span class="ot">&lt;-</span> log_r1[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time_bucket =</span> <span class="fu">ceiling</span>(time <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb5-702"><a href="#cb5-702" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_vol)</span>
<span id="cb5-703"><a href="#cb5-703" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(price <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-704"><a href="#cb5-704" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(BidAskSpread1 <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-705"><a href="#cb5-705" aria-hidden="true" tabindex="-1"></a>    <span class="co">#vol[[b]] &lt;- vol[[b]] %&gt;% mutate(aggregate(BidAskSpread2 ~ time_bucket, data = log_r1[[b]], FUN = comp_price))</span></span>
<span id="cb5-706"><a href="#cb5-706" aria-hidden="true" tabindex="-1"></a>    vol[[b]] <span class="ot">&lt;-</span> vol[[b]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">aggregate</span>(num_order <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[b]], <span class="at">FUN =</span> comp_price))</span>
<span id="cb5-707"><a href="#cb5-707" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(vol[[b]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, </span>
<span id="cb5-708"><a href="#cb5-708" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'volatility'</span>,</span>
<span id="cb5-709"><a href="#cb5-709" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'price'</span>, </span>
<span id="cb5-710"><a href="#cb5-710" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'BidAskSpread1'</span>, </span>
<span id="cb5-711"><a href="#cb5-711" aria-hidden="true" tabindex="-1"></a>                            <span class="co">#'BidAskSpread2', </span></span>
<span id="cb5-712"><a href="#cb5-712" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'num_order'</span> )</span>
<span id="cb5-713"><a href="#cb5-713" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-714"><a href="#cb5-714" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-715"><a href="#cb5-715" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-716"><a href="#cb5-716" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(vol)){</span>
<span id="cb5-717"><a href="#cb5-717" aria-hidden="true" tabindex="-1"></a>    inTrain <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(<span class="at">y=</span>vol[[e]]<span class="sc">$</span>volatility,<span class="at">p=</span><span class="fl">0.8</span>,<span class="at">list=</span><span class="cn">FALSE</span>)</span>
<span id="cb5-718"><a href="#cb5-718" aria-hidden="true" tabindex="-1"></a>    training <span class="ot">&lt;-</span> vol[[e]][inTrain, ]</span>
<span id="cb5-719"><a href="#cb5-719" aria-hidden="true" tabindex="-1"></a>    testing <span class="ot">&lt;-</span> vol[[e]][<span class="sc">-</span>inTrain, ]</span>
<span id="cb5-720"><a href="#cb5-720" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-721"><a href="#cb5-721" aria-hidden="true" tabindex="-1"></a>    glmnet6 <span class="ot">&lt;-</span> <span class="fu">train</span>(volatility <span class="sc">~</span> ., <span class="at">data =</span> training, <span class="at">method =</span> <span class="st">"glmnet"</span>,</span>
<span id="cb5-722"><a href="#cb5-722" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>),</span>
<span id="cb5-723"><a href="#cb5-723" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">1e-8</span>, <span class="fl">1e-1</span>, <span class="at">length =</span> <span class="dv">300</span>)))</span>
<span id="cb5-724"><a href="#cb5-724" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb5-725"><a href="#cb5-725" aria-hidden="true" tabindex="-1"></a>    predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet6, <span class="at">newdata =</span> testing)</span>
<span id="cb5-726"><a href="#cb5-726" aria-hidden="true" tabindex="-1"></a>    mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((predicted <span class="sc">-</span> testing<span class="sc">$</span>volatility)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb5-727"><a href="#cb5-727" aria-hidden="true" tabindex="-1"></a>    model_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(glmnet6)</span>
<span id="cb5-728"><a href="#cb5-728" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-729"><a href="#cb5-729" aria-hidden="true" tabindex="-1"></a>    <span class="fu">LossVol</span>(testing<span class="sc">$</span>volatility, predicted, <span class="at">which =</span> <span class="st">"SE1"</span>)</span>
<span id="cb5-730"><a href="#cb5-730" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-731"><a href="#cb5-731" aria-hidden="true" tabindex="-1"></a>    <span class="co">#rsquared &lt;- model_summary$r.squared</span></span>
<span id="cb5-732"><a href="#cb5-732" aria-hidden="true" tabindex="-1"></a>    total_mse6 <span class="ot">&lt;-</span> <span class="fu">c</span>(total_mse6, mse)</span>
<span id="cb5-733"><a href="#cb5-733" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb5-734"><a href="#cb5-734" aria-hidden="true" tabindex="-1"></a>      mse_list61 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list61, mse)</span>
<span id="cb5-735"><a href="#cb5-735" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-736"><a href="#cb5-736" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb5-737"><a href="#cb5-737" aria-hidden="true" tabindex="-1"></a>      mse_list62 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list62, mse)</span>
<span id="cb5-738"><a href="#cb5-738" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-739"><a href="#cb5-739" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb5-740"><a href="#cb5-740" aria-hidden="true" tabindex="-1"></a>      mse_list63 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list63, mse)</span>
<span id="cb5-741"><a href="#cb5-741" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-742"><a href="#cb5-742" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">4</span>){</span>
<span id="cb5-743"><a href="#cb5-743" aria-hidden="true" tabindex="-1"></a>      mse_list64 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list64, mse)</span>
<span id="cb5-744"><a href="#cb5-744" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-745"><a href="#cb5-745" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(count <span class="sc">==</span> <span class="dv">5</span>){</span>
<span id="cb5-746"><a href="#cb5-746" aria-hidden="true" tabindex="-1"></a>      mse_list65 <span class="ot">&lt;-</span> <span class="fu">c</span>(mse_list65, mse)</span>
<span id="cb5-747"><a href="#cb5-747" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-748"><a href="#cb5-748" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-749"><a href="#cb5-749" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-750"><a href="#cb5-750" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(total_mse6), <span class="fu">mean</span>(<span class="fu">sqrt</span>(total_mse6), <span class="fu">mean</span>(total_qlk6)))</span>
<span id="cb5-751"><a href="#cb5-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-752"><a href="#cb5-752" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(total_mse6,<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-753"><a href="#cb5-753" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(total_mse1, </span>
<span id="cb5-754"><a href="#cb5-754" aria-hidden="true" tabindex="-1"></a>        total_mse2,</span>
<span id="cb5-755"><a href="#cb5-755" aria-hidden="true" tabindex="-1"></a>        total_mse3, </span>
<span id="cb5-756"><a href="#cb5-756" aria-hidden="true" tabindex="-1"></a>        total_mse4,</span>
<span id="cb5-757"><a href="#cb5-757" aria-hidden="true" tabindex="-1"></a>        total_mse5, </span>
<span id="cb5-758"><a href="#cb5-758" aria-hidden="true" tabindex="-1"></a>        total_mse6,</span>
<span id="cb5-759"><a href="#cb5-759" aria-hidden="true" tabindex="-1"></a>        <span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-760"><a href="#cb5-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-761"><a href="#cb5-761" aria-hidden="true" tabindex="-1"></a>filtered_data1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">sqrt</span>(total_mse1), </span>
<span id="cb5-762"><a href="#cb5-762" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse1) <span class="sc">&gt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse1), <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-763"><a href="#cb5-763" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse1), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse1), <span class="fl">0.25</span>))</span>
<span id="cb5-764"><a href="#cb5-764" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">&amp;</span> </span>
<span id="cb5-765"><a href="#cb5-765" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse1) <span class="sc">&lt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse1), <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-766"><a href="#cb5-766" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse1), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse1), <span class="fl">0.25</span>)))</span>
<span id="cb5-767"><a href="#cb5-767" aria-hidden="true" tabindex="-1"></a>filtered_data2 <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">sqrt</span>(total_mse2), </span>
<span id="cb5-768"><a href="#cb5-768" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse2) <span class="sc">&gt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse2), <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-769"><a href="#cb5-769" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse2), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse2), <span class="fl">0.25</span>))</span>
<span id="cb5-770"><a href="#cb5-770" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">&amp;</span> </span>
<span id="cb5-771"><a href="#cb5-771" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse2) <span class="sc">&lt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse2), <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-772"><a href="#cb5-772" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse2), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse2), <span class="fl">0.25</span>)))</span>
<span id="cb5-773"><a href="#cb5-773" aria-hidden="true" tabindex="-1"></a>filtered_data3 <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">sqrt</span>(total_mse3), </span>
<span id="cb5-774"><a href="#cb5-774" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse3) <span class="sc">&gt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse3), <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-775"><a href="#cb5-775" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse3), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse3), <span class="fl">0.25</span>))</span>
<span id="cb5-776"><a href="#cb5-776" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">&amp;</span> </span>
<span id="cb5-777"><a href="#cb5-777" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse3) <span class="sc">&lt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse3), <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-778"><a href="#cb5-778" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse3), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse3), <span class="fl">0.25</span>)))</span>
<span id="cb5-779"><a href="#cb5-779" aria-hidden="true" tabindex="-1"></a>filtered_data4 <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">sqrt</span>(total_mse4), </span>
<span id="cb5-780"><a href="#cb5-780" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse4) <span class="sc">&gt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse4), <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-781"><a href="#cb5-781" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse4), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse4), <span class="fl">0.25</span>))</span>
<span id="cb5-782"><a href="#cb5-782" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">&amp;</span> </span>
<span id="cb5-783"><a href="#cb5-783" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse4) <span class="sc">&lt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse4), <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-784"><a href="#cb5-784" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse4), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse4), <span class="fl">0.25</span>)))</span>
<span id="cb5-785"><a href="#cb5-785" aria-hidden="true" tabindex="-1"></a>filtered_data5 <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">sqrt</span>(total_mse5), </span>
<span id="cb5-786"><a href="#cb5-786" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse5) <span class="sc">&gt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse5), <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-787"><a href="#cb5-787" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse5), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse5), <span class="fl">0.25</span>))</span>
<span id="cb5-788"><a href="#cb5-788" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">&amp;</span> </span>
<span id="cb5-789"><a href="#cb5-789" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse5) <span class="sc">&lt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse5), <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-790"><a href="#cb5-790" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse5), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse5), <span class="fl">0.25</span>)))</span>
<span id="cb5-791"><a href="#cb5-791" aria-hidden="true" tabindex="-1"></a>filtered_data6 <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">sqrt</span>(total_mse6), </span>
<span id="cb5-792"><a href="#cb5-792" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse6) <span class="sc">&gt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse6), <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-793"><a href="#cb5-793" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse6), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse6), <span class="fl">0.25</span>))</span>
<span id="cb5-794"><a href="#cb5-794" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">&amp;</span> </span>
<span id="cb5-795"><a href="#cb5-795" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sqrt</span>(total_mse6) <span class="sc">&lt;=</span> <span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse6), <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> </span>
<span id="cb5-796"><a href="#cb5-796" aria-hidden="true" tabindex="-1"></a>                          (<span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse6), <span class="fl">0.75</span>)<span class="sc">-</span><span class="fu">quantile</span>(<span class="fu">sqrt</span>(total_mse6), <span class="fl">0.25</span>)))</span>
<span id="cb5-797"><a href="#cb5-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-798"><a href="#cb5-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-799"><a href="#cb5-799" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(filtered_data1,filtered_data2,filtered_data3,filtered_data4,filtered_data5,filtered_data6, <span class="at">main =</span> <span class="st">"RMSE for each cluster"</span>)</span>
<span id="cb5-800"><a href="#cb5-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-801"><a href="#cb5-801" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(total_mse1, <span class="st">"pred1.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-802"><a href="#cb5-802" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(total_mse2, <span class="st">"pred2.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-803"><a href="#cb5-803" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(total_mse3, <span class="st">"pred3.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-804"><a href="#cb5-804" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(total_mse4, <span class="st">"pred4.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-805"><a href="#cb5-805" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(total_mse5, <span class="st">"pred5.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-806"><a href="#cb5-806" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(total_mse6, <span class="st">"pred6.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-807"><a href="#cb5-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-808"><a href="#cb5-808" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(filtered_data1, <span class="st">"pred1.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-809"><a href="#cb5-809" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(filtered_data2, <span class="st">"pred2.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-810"><a href="#cb5-810" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(filtered_data3, <span class="st">"pred3.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-811"><a href="#cb5-811" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(filtered_data4, <span class="st">"pred4.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-812"><a href="#cb5-812" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(filtered_data5, <span class="st">"pred5.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-813"><a href="#cb5-813" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(filtered_data6, <span class="st">"pred6.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Coding for HAR-RV</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Reading in stock csv file</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>stock_1 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"~/Desktop/DATA3888/individual_book_train/stock_41.csv"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculating necessary variables for HAR-RV model</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>stock_1 <span class="ot">&lt;-</span> stock_1 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAP =</span> (bid_price1 <span class="sc">*</span> ask_size1 <span class="sc">+</span> ask_price1 <span class="sc">*</span> bid_size1) <span class="sc">/</span> (bid_size1 <span class="sc">+</span> ask_size1))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>stock_1 <span class="ot">&lt;-</span> stock_1 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BidAskSpread =</span> ask_price1 <span class="sc">/</span> bid_price1 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculating volatilities for training and testing sets</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>log_r1 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>time_IDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(stock_1[, <span class="dv">1</span>])[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(time_IDs)) {</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  sec <span class="ot">&lt;-</span> stock_1 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> time_IDs[i]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(seconds_in_bucket)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  price <span class="ot">&lt;-</span> stock_1 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> time_IDs[i]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(WAP)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  log_r <span class="ot">&lt;-</span> <span class="fu">log</span>(price[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> price[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(price) <span class="sc">-</span> <span class="dv">1</span>)])</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  log_r1[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> sec[<span class="sc">-</span><span class="dv">1</span>], <span class="at">log_return =</span> log_r)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  time.no.change <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>)[<span class="sc">!</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span> <span class="sc">%in%</span> log_r1[[i]]<span class="sc">$</span>time)]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time.no.change) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    new.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time.no.change, <span class="at">log_return =</span> <span class="dv">0</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    log_r1[[i]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(log_r1[[i]], new.df)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    log_r1[[i]] <span class="ot">&lt;-</span> log_r1[[i]][<span class="fu">order</span>(log_r1[[i]]<span class="sc">$</span>time), ]</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>vol <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  log_r1[[i]] <span class="ot">&lt;-</span> log_r1[[i]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time_bucket =</span> <span class="fu">ceiling</span>(time <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  vol[[i]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[i]], <span class="at">FUN =</span> comp_vol)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(vol[[i]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, <span class="st">'volatility'</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>log_r1_2 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>time_IDs2 <span class="ot">&lt;-</span> <span class="fu">unique</span>(stock_1[, <span class="dv">1</span>])[<span class="dv">51</span><span class="sc">:</span><span class="dv">550</span>]</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(time_IDs2)) {</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  sec2 <span class="ot">&lt;-</span> stock_1 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> time_IDs2[i]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(seconds_in_bucket)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  price2 <span class="ot">&lt;-</span> stock_1 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_id <span class="sc">==</span> time_IDs2[i]) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(WAP)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  log_r2 <span class="ot">&lt;-</span> <span class="fu">log</span>(price2[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> price2[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(price2) <span class="sc">-</span> <span class="dv">1</span>)])</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  log_r1_2[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> sec2[<span class="sc">-</span><span class="dv">1</span>], <span class="at">log_return =</span> log_r2)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  time.no.change2 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>)[<span class="sc">!</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">600</span> <span class="sc">%in%</span> log_r1_2[[i]]<span class="sc">$</span>time)]</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time.no.change2) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    new.df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time.no.change2, <span class="at">log_return =</span> <span class="dv">0</span>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    log_r1_2[[i]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(log_r1_2[[i]], new.df2)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    log_r1_2[[i]] <span class="ot">&lt;-</span> log_r1_2[[i]][<span class="fu">order</span>(log_r1_2[[i]]<span class="sc">$</span>time), ]</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>vol_2 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>comp_vol <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1_2)) {</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>  log_r1_2[[i]] <span class="ot">&lt;-</span> log_r1_2[[i]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time_bucket =</span> <span class="fu">ceiling</span>(time <span class="sc">/</span> <span class="dv">30</span>))</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>  vol_2[[i]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1_2[[i]], <span class="at">FUN =</span> comp_vol)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(vol_2[[i]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, <span class="st">'volatility'</span>)</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>vol.train <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  vol.train[[i]] <span class="ot">&lt;-</span> vol[[i]]</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>len.train <span class="ot">&lt;-</span> <span class="fu">length</span>(vol.train[[<span class="dv">1</span>]]<span class="sc">$</span>volatility)</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculating mean volatilities</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>list.HAV <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(vol)) {</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  mean.vol <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, len.train <span class="sc">-</span> <span class="dv">5</span>)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="dv">5</span>) {</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    mean.vol <span class="ot">&lt;-</span> mean.vol <span class="sc">+</span> vol.train[[i]]<span class="sc">$</span>volatility[j <span class="sc">:</span> (j <span class="sc">+</span> len.train <span class="sc">-</span> <span class="dv">6</span>)] <span class="sc">/</span> <span class="dv">5</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>  list.HAV[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">vol =</span> vol.train[[i]]<span class="sc">$</span>volatility[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)], </span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>                              <span class="at">vol_1 =</span> vol.train[[i]]<span class="sc">$</span>volatility[<span class="dv">5</span><span class="sc">:</span>(len.train <span class="sc">-</span> <span class="dv">1</span>)],</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mean_vol_5 =</span> mean.vol)</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculating quarticity</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>quar <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>comp_quar <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">length</span>(x) <span class="sc">/</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sum</span>(x <span class="sc">^</span> <span class="dv">4</span>))</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1)) {</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  quar[[i]] <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(log_return <span class="sc">~</span> time_bucket, <span class="at">data =</span> log_r1[[i]], <span class="at">FUN =</span> comp_quar)</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(quar[[i]]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'time_bucket'</span>, <span class="st">'quarticity'</span>)</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a><span class="co">#Training models</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>HAV.ols.models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>HAV.wls.models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(vol)) {</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>  HAV.ols.models[[i]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(vol <span class="sc">~</span> vol_1 <span class="sc">+</span> mean_vol_5, list.HAV[[i]])</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>  HAV.wls.models[[i]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(vol <span class="sc">~</span> vol_1 <span class="sc">+</span> mean_vol_5, list.HAV[[i]],</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>                            <span class="at">weights =</span> list.HAV[[i]]<span class="sc">$</span>vol_1 <span class="sc">/</span> </span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">sqrt</span>(quar[[i]]<span class="sc">$</span>quarticity[<span class="dv">5</span><span class="sc">:</span>(len.train <span class="sc">-</span> <span class="dv">1</span>)]))</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a><span class="co">#Testing the model</span></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>vol.test <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(log_r1_2)) {</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>  vol.test[[i]] <span class="ot">&lt;-</span> vol_2[[i]]</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>len.test <span class="ot">&lt;-</span> <span class="fu">length</span>(vol.test[[<span class="dv">1</span>]]<span class="sc">$</span>volatility)</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>list.HAV.test <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">length</span>(vol_2)) {</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>  mean.vol.test <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, len.test <span class="sc">-</span> <span class="dv">5</span>)</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="dv">5</span>) {</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    mean.vol.test <span class="ot">&lt;-</span> mean.vol.test <span class="sc">+</span> vol.test[[i]]<span class="sc">$</span>volatility[j <span class="sc">:</span> (j <span class="sc">+</span> len.test <span class="sc">-</span> <span class="dv">6</span>)] <span class="sc">/</span> <span class="dv">5</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>  list.HAV.test[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">vol =</span> vol.test[[i]]<span class="sc">$</span>volatility[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)], </span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>                              <span class="at">vol_1 =</span> vol.test[[i]]<span class="sc">$</span>volatility[<span class="dv">5</span><span class="sc">:</span>(len.test <span class="sc">-</span> <span class="dv">1</span>)],</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mean_vol_5 =</span> mean.vol)</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculating RMSE and computing boxplot</span></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>RMSE <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>){</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>    predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(HAV.wls.models[[i]], <span class="at">newdata =</span> list.HAV.test[[(i<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">5</span> <span class="sc">+</span> j]])</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>    mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((predicted <span class="sc">-</span> list.HAV.test[[(i<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">5</span> <span class="sc">+</span> j]]<span class="sc">$</span>vol)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>    rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(mse)</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>    RMSE <span class="ot">&lt;-</span> <span class="fu">append</span>(RMSE, rmse)</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(RMSE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="section" class="level3">
<h3 class="anchored" data-anchor-id="section"></h3>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>